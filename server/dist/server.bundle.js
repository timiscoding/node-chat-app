!function(e){var r={};function t(s){if(r[s])return r[s].exports;var o=r[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=r,t.d=function(e,r,s){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:s})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(s,o,function(r){return e[r]}.bind(null,o));return s},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=27)}([function(e,r){e.exports=require("mongoose")},function(e,r){e.exports=require("passport")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("hbs")},function(e,r,t){"use strict";(function(e){t.d(r,"a",function(){return v}),t.d(r,"b",function(){return O});var s=t(2),o=t.n(s),n=t(24),a=t.n(n),i=t(23),c=t.n(i),u=t(4),l=t.n(u),d=t(22),m=t.n(d),g=t(3),p=t.n(g),f=t(10),h=(t(25),t(11)),b=t(16),w=t(12);const y=o()(),v=a.a.createServer(y),O=c()(v);Object(f.a)().catch(e=>console.error("Could not connect to DB",e.message)),l.a.localsAsTemplateData(y),l.a.registerHelper("toJSON",e=>JSON.stringify(e,null,2));const U=m()(l.a);U.registerPartials.bind(U)(p.a.join(e,"../views/partials"),{}),y.set("view engine","hbs"),y.use(b.a),O.on("connection",e=>{console.log("New user connected"),Object(h.a)(e,O)}),y.use((e,r,t)=>{const s=e.flash();r.locals.user=e.user,r.locals.flashes=Object.keys(s).length>0?s:void 0,t()}),y.use("/",w.a)}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,r){e.exports=require("express-validator/check")},function(e,r){e.exports=require("body-parser")},function(e,r){e.exports=require("moment")},function(e,r){e.exports=require("bcrypt")},function(e,r,t){"use strict";var s=t(0),o=t.n(s),n=t(9),a=t.n(n),i=t(21),c=t.n(i),u=t(20),l=t.n(u);const d=new o.a.Schema({email:{type:String,unique:"An account with email {VALUE} already exists",sparse:!0,trim:!0,lowercase:!0,validate:[c.a,"Email is not valid"]},password:{type:String,trim:!0,minlength:5},username:{type:String,required:"Username is required",unique:"Username already taken",sparse:!0,lowercase:!0,trim:!0,match:[/^[\w-]+$/,"Username must contain alphanumeric, '-', '_' characters only"]},facebookId:{type:String,unique:"An account with this Facebook already exists",sparse:!0}});d.methods={hashPassword(e){if(!e)throw new Error("Password cannot be blank");return a.a.hash(e,12)},isValidPassword(e){return a.a.compare(e,this.password)}},d.pre("save",async function(e){this.password&&(this.password=await this.hashPassword(this.password)),e()}),d.plugin(l.a);o.a.model("User",d);r.a=(async()=>o.a.connect(process.env.DB_URL))},function(e,r,t){"use strict";var s=e=>"string"==typeof e&&e.trim().length>0,o=t(8),n=t.n(o);const a=(e,r)=>({from:e,text:r,createdAt:n()().valueOf()});const i=(()=>{let e;const r=()=>new class{constructor(){this.users=[]}addUser(e,r,t){const s={id:e,name:r,room:t};return this.users.push(s),s}removeUser(e){const r=Object.assign({},this.getUser({id:e}));return r&&(this.users=this.users.filter(e=>e.id!==r.id)),r}getUser({id:e,name:r}){return this.users.find(t=>t.id===e||t.name===r)}getUserList(e){return this.users.filter(r=>r.room===e).map(e=>e.name)}getRoomList(){return[...new Set(this.users.map(e=>e.room))]}};return{getInstance:()=>(e||(e=r()),e)}})().getInstance(),c=e=>{e.emit("updateRoomList",{rooms:i.getRoomList()})},u=(e,r)=>e.on("createLocationMessage",t=>{const s=i.getUser({id:e.id});s&&r.to(s.room).emit("newLocationMessage",((e,r,t)=>({from:e,url:`https://www.google.com/maps?q=${r},${t}`,createdAt:n()().valueOf()}))(s.name,t.latitude,t.longitude))});r.a=((e,r)=>({joinRoom:((e,r)=>e.on("join",(t,o)=>{if(!s(t.name)||!s(t.room))return o("Name and Room name are required!");const n=t.name.trim(),u=t.room.trim().toLowerCase(),l=i.getUser({name:n});return l&&l.room===u?o("Username taken!"):(e.join(u),i.removeUser(e.id),i.addUser(e.id,n,u),r.to(u).emit("updateUserList",i.getUserList(u)),e.emit("newMessage",a("Admin",`Welcome to the room ${u}!`)),e.broadcast.to(u).emit("newMessage",a("Admin",`${n} joined the chat`)),c(r),o())}))(e,r),createMessage:((e,r)=>e.on("createMessage",(t,o)=>{const n=i.getUser({id:e.id});n&&s(t.text)&&r.to(n.room).emit("newMessage",a(n.name,t.text)),o()}))(e,r),createLocationMessage:u(e,r),disconnect:((e,r)=>e.on("disconnect",()=>{const t=i.removeUser(e.id);r.to(t.room).emit("updateUserList",i.getUserList(t.room)),r.to(t.room).emit("newMessage",a("Admin",`${t.name} has left`)),c(r)}))(e,r),getRoomList:(e=>e.on("getRoomList",(e,r)=>{r({rooms:i.getRoomList()})}))(e)}))},function(e,r,t){"use strict";var s=t(2),o=t.n(s),n=t(13),a=t(0),i=t.n(a),c=t(6);const u=e=>(r,t,s)=>e(r,t,s).catch(s),l=i.a.model("User"),d=[Object(c.checkSchema)({username:{in:"body",isLength:{errorMessage:"Username must not be empty",options:{min:1}},matches:{errorMessage:"Username must be letters, numbers, '_', '-' only",options:/^[\w-]+$/},trim:!0},email:{in:"body",isEmail:{errorMessage:"Email address is not valid"},trim:!0,normalizeEmail:{options:{all_lowercase:!0,gmail_convert_googlemaildotcom:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0}}},password:{in:"body",isLength:{errorMessage:"Password must be at least 5 characters long",options:{min:5}},trim:!0},"password-confirm":{in:"body",custom:{options:(e,{req:r})=>{if(r.body.password!==e)throw new Error("Password confirmation does not match password field");return!0}}}}),(e,r,t)=>{const s=Object(c.validationResult)(e).formatWith(({msg:e})=>e);s.isEmpty()?t():(e.flash("error",s.array({onlyFirstError:!0})),r.render("signup",{body:e.body,flashes:e.flash()}))}];var m={createOne:async(e,r,t)=>{const{email:s,password:o,username:n}=e.body,a=new l({email:s,password:o,username:n});try{await a.save(),e.login(a,t),e.flash("success","New account created!"),r.redirect("/")}catch(o){if(o.errors){const t=Object.keys(o.errors).map(e=>o.errors[e].message);e.flash("error",t),r.render("signup",{body:{username:n,email:s},flashes:e.flash()})}else t(o)}},getOne:u(async(e,r)=>{const t=await l.findById(e.user.id);r.send(`get user\n ${t}`)}),updateOne:u((e,r)=>{r.send(`update user\n ${e.docFromId}`)}),deleteOne:u((e,r)=>{r.send(`delete user\n ${e.docFromId}`)}),signupForm:(e,r)=>{r.render("signup")},validateNewUser:d};const g=o.a.Router(),p=i.a.model("User");g.param("id",async(e,r,t,s)=>{try{if(!i.a.Types.ObjectId.isValid(s))throw new Error("Invalid user id");const r=await p.findById(s);if(!r)throw new Error("No user found");e.docFromId=r,t()}catch(e){t(e.message)}}),g.route("/signup").get(m.signupForm).post(m.validateNewUser,m.createOne),g.route("/user/:id").get(Object(n.ensureLoggedIn)(),m.getOne).put(m.updateOne).delete(m.deleteOne);var f=t(1),h=t.n(f);var b={loginForm:(e,r)=>{r.render("login")},loginUser:h.a.authenticate("local",{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:!0,successFlash:!0}),logoutUser:(e,r)=>{e.logout(),e.flash("info","You have logged out"),r.redirect("/")},loginFacebook:h.a.authenticate("facebook"),loginFacebookCallback:h.a.authenticate("facebook",{failureRedirect:"/login",failureFlash:"You did not authorize this app to login via Facebook",successFlash:!0,successReturnToOrRedirect:"/"})};const w=o.a.Router();w.get("/login",b.loginForm),w.get("/login/facebook",b.loginFacebook),w.get("/login/facebook/callback",b.loginFacebookCallback),w.post("/login",b.loginUser),w.get("/logout",b.logoutUser);const y=o.a.Router();y.use("/",w),y.use("/",g),y.get("/",(e,r)=>{console.log("user",e.user),r.render("index",{title:"Join"})}),y.post("/chat",(e,r)=>{r.render("chat",{title:"Chat"})}),y.use((e,r,t,s)=>{if(!e.errors)return s(e);const o=Object.keys(e.errors);return o.length>0&&o.forEach(t=>r.flash("error",e.errors[t].message)),t.redirect("back")}),y.use((e,r,t,s)=>{t.status(500).send(`something messed up: ${e.message}`)});r.a=y},function(e,r){e.exports=require("connect-ensure-login")},function(e,r){e.exports=require("connect-flash")},function(e,r){e.exports=require("express-session")},function(e,r,t){"use strict";(function(e){var s=t(2),o=t.n(s),n=t(3),a=t.n(n),i=t(7),c=t.n(i),u=t(1),l=t.n(u),d=t(15),m=t.n(d),g=t(14),p=t.n(g);r.a=[o.a.static(a.a.join(e,"../public")),c.a.json(),c.a.urlencoded({extended:!0}),m()({secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!1}),l.a.initialize(),l.a.session(),p()()]}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,r){e.exports=require("lodash")},function(e,r){e.exports=require("passport-facebook")},function(e,r){e.exports=require("passport-local")},function(e,r){e.exports=require("mongoose-beautiful-unique-validation")},function(e,r){e.exports=require("validator/lib/isEmail")},function(e,r){e.exports=require("hbs-utils")},function(e,r){e.exports=require("socket.io")},function(e,r){e.exports=require("http")},function(e,r,t){"use strict";var s=t(1),o=t.n(s),n=t(19),a=t.n(n),i=t(18),c=t.n(i),u=t(0),l=t.n(u),d=t(17),m=t.n(d);const g=l.a.model("User");o.a.use(new a.a({usernameField:"email"},async(e,r,t)=>{try{const s=await g.findOne({email:e});return s&&await s.isValidPassword(r)?t(null,s,{message:`You have logged in, ${s.username}`}):t(null,!1,{message:"User or password is invalid"})}catch(e){return t(e,null,{message:"Could not authenticate. Please try again"})}})),o.a.use(new c.a({clientID:process.env.FACEBOOK_APP_ID,clientSecret:process.env.FACEBOOK_APP_SECRET,callbackURL:`${process.env.DOMAIN}/login/facebook/callback`},async(e,r,t,s)=>{try{let e=await g.findOne({facebookId:t.id});if(e)return s(null,e,{message:`You have logged in, ${e.username}`});const r=t.displayName.toLowerCase().replace(/ /g,"_"),o=new RegExp(`^${r}d*$`),n=await g.find({username:o},"username");let a=r;for(let e=0;m.a.find(n,{username:a});e+=1)a=r+(n.length+e);return s(null,e=await g.create({facebookId:t.id,username:a}),{message:`You have logged in, ${e.username}`})}catch(e){s(e,!1,{message:"Could not authenticate. Please try again"})}})),o.a.serializeUser((e,r)=>r(null,e.id)),o.a.deserializeUser(async(e,r)=>{try{return r(null,await g.findById(e))}catch(e){return r(e)}})},function(e,r,t){"use strict";t.r(r);var s=t(5);const o=process.env.PORT||4e3;s.a,s.b;s.a.listen(o,()=>{console.log(`Server started on port ${o}`)})},function(e,r,t){e.exports=t(26)}]);
//# sourceMappingURL=server.bundle.js.map