!function(e){var r={};function s(t){if(r[t])return r[t].exports;var o=r[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=r,s.d=function(e,r,t){s.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,r){if(1&r&&(e=s(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)s.d(t,o,function(r){return e[r]}.bind(null,o));return t},s.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(r,"a",r),r},s.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},s.p="",s(s.s=28)}([function(e,r){e.exports=require("mongoose")},function(e,r){e.exports=require("passport")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("lodash")},function(e,r){e.exports=require("path")},function(e,r,s){"use strict";(function(e){var t=s(16),o=s.n(t),a=s(4),n=s.n(a);const i=new o.a({message:{from:"no-reply@timiscoding.me"},transport:{port:process.env.MAILER_PORT,host:process.env.MAILER_HOST,auth:{user:process.env.MAILER_USERNAME,pass:process.env.MAILER_PASSWORD}},juice:!0,juiceResources:{webResources:{relativeTo:n.a.join(e,"../views/emails/build")}},views:{root:n.a.join(e,"../views/emails")}});r.a=i}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,r){e.exports=require("crypto")},function(e,r){e.exports=require("express-validator/check")},function(e,r){e.exports=require("express-session")},function(e,r){e.exports=require("body-parser")},function(e,r,s){"use strict";(function(e){s.d(r,"b",function(){return y});var t=s(2),o=s.n(t),a=s(4),n=s.n(a),i=s(9),l=s.n(i),c=s(1),u=s.n(c),d=s(8),m=s.n(d),p=s(15),f=s.n(p),g=s(0),h=s.n(g);const w={secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!1};{const e=s(27)(m.a);w.store=new e({mongooseConnection:h.a.connection,autoRemove:"native"})}const y=m()(w);r.a=[o.a.static(n.a.join(e,"../public")),l.a.json(),l.a.urlencoded({extended:!0}),y,u.a.initialize(),u.a.session(),f()()]}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,r){e.exports=require("moment")},function(e,r){e.exports=require("bcrypt")},function(e,r){e.exports=require("request-promise")},function(e,r){e.exports=require("connect-ensure-login")},function(e,r){e.exports=require("connect-flash")},function(e,r){e.exports=require("email-templates")},function(e,r){e.exports=require("passport-google-oauth")},function(e,r){e.exports=require("passport-twitter")},function(e,r){e.exports=require("passport-facebook")},function(e,r){e.exports=require("passport-local")},function(e,r){e.exports=require("mongoose-beautiful-unique-validation")},function(e,r){e.exports=require("validator/lib/isEmail")},function(e,r){e.exports=require("es6-promisify")},function(e,r){e.exports=require("socket.io")},function(e,r){e.exports=require("http")},function(e,r,s){"use strict";s.r(r);var t=s(2),o=s.n(t),a=s(25),n=s.n(a),i=s(24),l=s.n(i),c=s(23),u=s(0),d=s.n(u),m=s(12),p=s.n(m),f=s(22),g=s.n(f),h=s(21),w=s.n(h),y=s(3),v=s.n(y);const b=new d.a.Schema({username:{type:String,required:"Username is required",unique:"Username already taken",sparse:!0,lowercase:!0,trim:!0,match:[/^[\w-]+$/,"Username must contain alphanumeric, '-', '_' characters only"]},local:{email:{type:String,unique:"An account with email {VALUE} already exists",sparse:!0,trim:!0,lowercase:!0,validate:[g.a,"Email is not valid"]},password:{type:String,trim:!0,minlength:5},isVerified:{type:Boolean,default:!1}},facebook:{id:String,token:String,displayName:String,email:String},twitter:{id:String,token:String,displayName:String,username:String},google:{id:String,token:String,displayName:String,email:String},passwordResetToken:String,passwordResetExpires:Date});b.methods.isValidPassword=function(e){return p.a.compare(e,this.local.password)};const k=["twitter","google","facebook","local"];b.methods.accountsTotal=function(){return Object.keys(this.toObject()).reduce((e,r)=>k.includes(r)&&("local"===r||"local"!==r&&this[r].token)?e+1:e,0)},b.statics.hashPassword=function(e){if(!e)throw new Error("Password cannot be blank");return p.a.hash(e,12)},b.statics.genUniqueUsername=async function(e="anon"){const r=e.toLowerCase().replace(/ /g,"_"),s=new RegExp(`^${r}d*$`),t=await this.find({username:s},"username");let o=r;for(let e=0;v.a.find(t,{username:o});e+=1)o=r+(t.length+e);return o},b.plugin(w.a);d.a.model("User",b);var E=s(6),R=s.n(E);const O=new d.a.Schema({user:{type:d.a.Schema.Types.ObjectId,ref:"User",required:!0},createdAt:{type:Date,expires:"5 min",default:Date.now},token:{type:String,required:!0}}),P=()=>R.a.randomBytes(20).toString("hex");O.statics.findOneOrCreate=async function(e){const r=this;if(e){return await r.findOne({user:e})||r.create({user:e,token:P()})}return new Error("User id not given")},O.statics.createToken=async function(e){return this.create({user:e,token:P()})};d.a.model("EmailVerifyToken",O);var U=async()=>d.a.connect(process.env.DB_URL),T=s(1),S=s.n(T),_=s(20),x=s.n(_),A=s(19),q=s.n(A),C=s(18),L=s.n(C),j=s(17);const $=d.a.model("User");S.a.use(new x.a({usernameField:"email",passReqToCallback:!0},async(e,r,s,t)=>{try{const e=await $.findOne({"local.email":r});return e&&await e.isValidPassword(s)?e.local.isVerified?t(null,e):t(null,!1,{message:'The email has not been verified for this account. <a href="/resend">Resend email confirmation</a>'}):t(null,!1,{message:"Email or password is invalid"})}catch(e){return t(e,null,{message:"Could not authenticate. Please try again"})}}));const I=e=>e.emails&&e.emails.length&&e.emails[0].value,M=async(e,r,s)=>$.create({[e]:{id:s.id,displayName:s.displayName,token:r,email:I(s)},username:await $.genUniqueUsername(s.username||s.displayName)}),F=e=>async(r,s,t,o,a)=>{try{let t=await $.findOne({[`${e}.id`]:o.id});return r.user?t?(t[e].token||(t=await M(e,s,o)),a(null,t)):a(null,t=await M(e,s,o)):t?(t[e].token||(t[e]={id:o.id,displayName:o.displayName,token:s,email:I(o)},t=await t.save()),a(null,t)):a(null,t=await M(e,s,o),{firstLogin:!0})}catch(e){return a(e,!1,{message:"Could not authenticate. Please try again"})}};S.a.use(new q.a({clientID:process.env.FACEBOOK_APP_ID,clientSecret:process.env.FACEBOOK_APP_SECRET,callbackURL:`${process.env.DOMAIN}/auth/facebook/callback`,profileFields:["email","displayName"],passReqToCallback:!0},F("facebook"))),S.a.use(new L.a({consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,callbackURL:`${process.env.DOMAIN}/auth/twitter/callback`,passReqToCallback:!0},F("twitter"))),S.a.use(new j.OAuth2Strategy({clientID:process.env.GOOGLE_APP_ID,clientSecret:process.env.GOOGLE_APP_SECRET,callbackURL:`${process.env.DOMAIN}/auth/google/callback`,passReqToCallback:!0},F("google"))),S.a.serializeUser((e,r)=>r(null,e.id)),S.a.deserializeUser(async(e,r)=>{try{return r(null,await $.findById(e))}catch(e){return r(e)}});var N=s(5);var D=e=>"string"==typeof e&&e.trim().length>0,K=s(11),V=s.n(K);const B=(e,r)=>({from:e,text:r,createdAt:V()().valueOf()});const H=(()=>{let e;const r=()=>new class{constructor(){this.users=[]}addUser(e,r,s){const t={id:e,name:r,room:s};return this.users.push(t),t}removeUser(e){const r=Object.assign({},this.getUser({id:e}));return r&&(this.users=this.users.filter(e=>e.id!==r.id)),r}getUser({id:e,name:r}){return this.users.find(s=>s.id===e||s.name===r)}getUserList(e){return this.users.filter(r=>r.room===e).map(e=>e.name)}getRoomList(){return[...new Set(this.users.map(e=>e.room))]}};return{getInstance:()=>(e||(e=r()),e)}})().getInstance(),Y=d.a.model("User"),G=e=>{e.emit("updateRoomList",{rooms:H.getRoomList()})},z=(e,r)=>e.on("createLocationMessage",s=>{const t=H.getUser({id:e.id});t&&r.to(t.room).emit("newLocationMessage",((e,r,s)=>({from:e,url:`https://www.google.com/maps?q=${r},${s}`,createdAt:V()().valueOf()}))(t.name,s.latitude,s.longitude))});var W=(e,r)=>({joinRoom:((e,r)=>e.on("join",async(s,t)=>{if(!D(s.room))return t("Room name required!");const o=s.room.trim().toLowerCase();e.join(o);const{passport:a}=e.handshake.session;let n;if(a&&a.user)try{n=(await Y.findById(a.user)).username}catch(e){return t("Could not retrieve user information")}else{let r=-4;do{n=`guest-${e.id.slice(r).toLowerCase()}`,r-=1}while(H.getUser({name:n}))}return H.removeUser(e.id),H.addUser(e.id,n,o),r.to(o).emit("updateUserList",H.getUserList(o)),e.emit("newMessage",B("Admin",`Welcome to the room ${o}!`)),e.broadcast.to(o).emit("newMessage",B("Admin",`${n} joined the chat`)),G(r),t()}))(e,r),createMessage:((e,r)=>e.on("createMessage",(s,t)=>{const o=H.getUser({id:e.id});o&&D(s.text)&&r.to(o.room).emit("newMessage",B(o.name,s.text)),t()}))(e,r),createLocationMessage:z(e,r),disconnect:((e,r)=>e.on("disconnect",()=>{const s=H.removeUser(e.id);r.to(s.room).emit("updateUserList",H.getUserList(s.room)),r.to(s.room).emit("newMessage",B("Admin",`${s.name} has left`)),G(r)}))(e,r),getRoomList:(e=>e.on("getRoomList",(e,r)=>{r({rooms:H.getRoomList()})}))(e)}),J=s(10),Q=s(14),X=s(13),Z=s.n(X),ee=s(7);const re={username:{in:"body",isLength:{errorMessage:"Username must not be empty",options:{min:1}},custom:{options:e=>{if(!/^[\w-]+$/.test(e))throw new Error("Username must be letters, numbers, '_', ' -' only");if(/^guest-\w+$/i.test(e))throw new Error("Usernames beginning with 'guest-' are reserved for unregistered users");return!0}},trim:!0},email:{in:"body",isEmail:{errorMessage:"Email address is not valid"},trim:!0,normalizeEmail:{options:{all_lowercase:!0,gmail_convert_googlemaildotcom:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0}}},password:{in:"body",isLength:{errorMessage:"Password must be at least 5 characters long",options:{min:5}},trim:!0},"password-confirm":{in:"body",custom:{options:(e,{req:r})=>{if(r.body.password!==e)throw new Error("Password confirmation does not match password field");return!0}}}},se=(...e)=>e.length?v.a.pick(re,e):re,te=(e,r)=>[Object(ee.checkSchema)(e),(e,s,t)=>{const o=Object(ee.validationResult)(e).formatWith(({msg:e})=>e);o.isEmpty()?t():(e.flash("error",o.array({onlyFirstError:!0})),s.render(r,{body:e.body,flashes:e.flash(),recaptchaKey:process.env.G_RECAPTCHA_SITE_KEY}))}],oe=e=>(r,s,t)=>e(r,s,t).catch(t),ae=d.a.model("User"),ne=d.a.model("EmailVerifyToken"),ie=te(se(),"signup"),le=te(se("email"),"confirmEmail"),ce=te(se("password","password-confirm"),"resetPassword");var ue={createOne:oe(async(e,r,s)=>{const{email:t,password:o,username:a}=e.body;try{const n=await ae.create({local:{email:t,password:await ae.hashPassword(o)},username:a});e.emailToken=await ne.createToken(n.id),s()}catch(o){if(o.errors){const s=Object.keys(o.errors).map(e=>o.errors[e].message);e.flash("error",s),r.render("signup",{body:{username:a,email:t},flashes:e.flash()})}else s(o)}}),getOne:oe(async(e,r)=>{const s=await ae.findById(e.user.id);r.send(`get user\n ${s}`)}),updateOne:oe((e,r)=>{r.send(`update user\n ${e.docFromId}`)}),deleteOne:oe((e,r)=>{r.send(`delete user\n ${e.docFromId}`)}),signupForm:(e,r)=>{r.render("signup",{recaptchaKey:process.env.G_RECAPTCHA_SITE_KEY})},validateNewUser:ie,confirmEmail:oe(async(e,r)=>{const s=await ne.findOneAndRemove({token:e.params.token}).populate("user");if(!s)return e.flash("error",'Email verification invalid. Either the link does not match the one provided\n      in the email or the link may have expired. <a href="/resend">Resend email confirmation</a>'),r.redirect("/");const{user:t}=s;return t.local.isVerified=!0,await t.save(),await e.login(t),e.flash("success","Your email has been confirmed. You are now logged in"),r.redirect("/")}),requestResend:(e,r)=>{r.render("confirmEmail",{recaptchaKey:process.env.G_RECAPTCHA_SITE_KEY})},validateEmail:le,resend:async(e,r,s)=>{const t=await ae.findOne({"local.email":e.body.email});return t&&t.local?t.local&&t.local.isVerified?(e.flash("info","The email for this account is already confirmed"),r.redirect("/")):(e.emailToken=await ne.findOneOrCreate(t.id),e.body.username=t.username,s()):(e.flash("info","An account with this email does not exist"),r.render("confirmEmail",{body:e.body,flashes:e.flash()}))},sendConfirmEmail:(e,r)=>{const{email:s,username:t}=e.body;N.a.send({template:"verifyEmail",message:{to:s},locals:{name:t,confirmURL:`${e.protocol}://${e.hostname}/confirm/${e.emailToken.token}`}}),e.flash("info",`An email has been sent to ${s}. Please confirm your email to complete sign up.`),r.redirect("/")},forgotPasswordForm:(e,r)=>{r.render("forgotPassword",{recaptchaKey:process.env.G_RECAPTCHA_SITE_KEY})},forgotPassword:oe(async(e,r,s)=>{const t=await ae.findOne({"local.email":e.body.email});return t&&t.local?(t.passwordResetToken=R.a.randomBytes(20).toString("hex"),t.passwordResetExpires=Date.now()+36e5,await t.save(),e.emailToken=t.passwordResetToken,e.body.username=t.username,s()):(e.flash("info","An account with this email does not exist"),r.render("forgotPassword",{body:e.body,flashes:e.flash()}))}),sendResetEmail:(e,r)=>{const{email:s,username:t}=e.body;N.a.send({template:"resetPassword",message:{to:s},locals:{name:t,resetURL:`${e.protocol}://${e.hostname}/reset/${e.emailToken}`}}),e.flash("info",`An email has been sent to ${s} with instructions to reset your password.`),r.redirect("/")},resetPasswordForm:async(e,r)=>{r.render("resetPassword")},validatePassword:ce,resetPassword:oe(async(e,r,s)=>{const{user:t}=e;t.local.password=await ae.hashPassword(e.body.password),t.passwordResetExpires=void 0,t.passwordResetToken=void 0,await t.save(),await e.login(t),s()}),validResetToken:oe(async(e,r,s)=>{const t=await ae.findOne({passwordResetToken:e.params.token,passwordResetExpires:{$gt:Date.now()}});return t?(e.user=t,s()):(e.flash("error","This password reset is invalid or expired. Please request a new one"),r.redirect("/forgot"))}),sendPasswordUpdatedEmail:oe(async(e,r)=>{const{local:{email:s},username:t}=e.user;N.a.send({template:"updatedPassword",message:{to:s},locals:{name:t}}),e.flash("success","Password has been updated"),r.redirect("/")}),validateHuman:e=>async(r,s,t)=>{const o={method:"POST",uri:"https://www.google.com/recaptcha/api/siteverify",formData:{secret:process.env.G_RECAPTCHA_SECRET,response:r.body["g-recaptcha-response"]},json:!0};try{if((await Z()(o)).success)return t()}catch(e){return t(e)}return r.flash("error","reCaptcha failed. Please try again"),s.render(e,{body:r.body,flashes:r.flash(),recaptchaKey:process.env.G_RECAPTCHA_SITE_KEY})}};const de=o.a.Router(),me=d.a.model("User");de.param("id",async(e,r,s,t)=>{try{if(!d.a.Types.ObjectId.isValid(t))throw new Error("Invalid user id");const r=await me.findById(t);if(!r)throw new Error("No user found");e.docFromId=r,s()}catch(e){s(e.message)}}),de.route("/signup").get(ue.signupForm).post(ue.validateNewUser,ue.validateHuman("signup"),ue.createOne,ue.sendConfirmEmail),de.route("/user/:id").get(Object(Q.ensureLoggedIn)(),ue.getOne).put(ue.updateOne).delete(ue.deleteOne),de.route("/resend").get(ue.requestResend).post(ue.validateEmail,ue.validateHuman("confirmEmail"),ue.resend,ue.sendConfirmEmail),de.get("/confirm/:token",ue.confirmEmail),de.route("/forgot").get(ue.forgotPasswordForm).post(ue.validateEmail,ue.validateHuman("forgotPassword"),ue.forgotPassword,ue.sendResetEmail),de.route("/reset/:token").get(ue.validResetToken,ue.resetPasswordForm).post(ue.validResetToken,ue.validatePassword,ue.resetPassword,ue.sendPasswordUpdatedEmail);const pe=d.a.model("User");var fe={loginForm:(e,r)=>r.render("login"),loginUser:S.a.authenticate("local",{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:!0,successFlash:"You have logged in"}),logoutUser:(e,r)=>{e.logout(),e.flash("info","You have logged out"),r.redirect("/")},genOauthLogin:(e,r={})=>({auth:(s,t,o)=>(s.user?S.a.authorize:S.a.authenticate).call(S.a,e,r.scope&&{scope:r.scope})(s,t,o),authCb(r,s,t){const o=r.user?S.a.authorize:S.a.authenticate,a=r.user?{failureRedirect:"/profile",failureFlash:`${e} account was not linked`}:(o,a,n)=>o?t(o):a?r.login(a,o=>o?t(o):(r.flash("success",`You have logged in, ${a[e].displayName||a[e].username}`),n.firstLogin?s.redirect("/profile"):s.redirect("/"))):(r.flash("error",`Permission to login via ${e} was denied`),s.redirect("/login"));return o.call(S.a,e,a)(r,s,t)}}),profile:(e,r)=>{const{user:s}=e,t=Object.entries(s.toObject()).reduce((e,[r,s])=>(("local"===r&&s.email||s.token)&&(e[r]=s.email||s.displayName),e),{}),o=["local","twitter","google","facebook"].filter(e=>!t[e]);r.render("profile",{body:{username:e.user.username,email:e.user.local.email},linkedAccounts:t,linkable:o})},authLocal:S.a.authorize("local",{failureRedirect:"/link/local",failureFlash:"Email or password is invalid"}),linkAccount:async(e,r,s)=>{const{user:t,account:o}=e;if(t&&o){const s=o.toObject({transform(e,r){const s=Object.assign({},r);return delete s.__v,delete s._id,s}});return s.local&&await pe.deleteOne({"local.email":s.local.email}),Object.assign(t,s,{username:t.username}),await t.save(),await o.remove(),e.flash("success","Accounts have been linked"),r.redirect("/profile")}return s()},unlinkAccount:async(e,r,s)=>{const t=e.params.account,{user:o}=e;if(!["twitter","google","facebook","local"].includes(t)){const e=new Error("Unknown account type");return e.status=400,s(e)}if(1===o.accountsTotal)return e.flash("error","Unable to unlink solo account"),r.redirect("/profile");if("local"===t){const e=Object.assign({},o.local);o.local=void 0,await o.save(),await pe.create({local:e,username:await pe.genUniqueUsername()})}else o[t].token=void 0,await o.save();return e.flash("success","Account has been unlinked"),r.redirect("/profile")},linkLocalForm:(e,r)=>r.render("link_local"),validateProfile:te(se("username","email"),"profile"),updateProfile:async(e,r)=>{const{username:s,email:t,password:o}=e.body;s!==e.user.username&&(e.user.username=s),e.user.local&&t!==e.user.local.email&&(e.user.local.email=t),o&&(e.user.local.password=await pe.hashPassword(o)),await e.user.save(),e.flash("success","Account updated"),r.redirect("/profile")},preValidateProfile:(e,r,s)=>e.body.password?s("route"):s(),validateProfilePassword:te(se("username","email","password","password-confirm"),"profile")};const ge=(e,r,s)=>{e.isAuthenticated()?s():r.redirect("/")},he=o.a.Router();he.get("/login",fe.loginForm),he.post("/login",fe.loginUser),he.get("/logout",ge,fe.logoutUser),he.get("/profile",ge,fe.profile),he.post("/profile",ge,fe.preValidateProfile,fe.validateProfile,oe(fe.updateProfile)),he.post("/profile",fe.validateProfilePassword,oe(fe.updateProfile)),he.get("/link/local",ge,fe.linkLocalForm),he.post("/link/local",ge,fe.authLocal,oe(fe.linkAccount)),he.post("/unlink/:account",ge,oe(fe.unlinkAccount)),[{provider:"facebook",config:{scope:"email"}},{provider:"twitter"},{provider:"google",config:{scope:"https://www.googleapis.com/auth/userinfo.profile"}}].forEach(({provider:e,config:r})=>{const{auth:s,authCb:t}=fe.genOauthLogin(e,r);he.get(`/auth/${e}`,s),he.get(`/auth/${e}/callback`,t,oe(fe.linkAccount)),he.get(`/link/${e}`,ge,s)});const we=o.a.Router();we.use("/",he),we.use("/",de),we.get("/",(e,r)=>{r.render("index",{title:"Join"})}),we.post("/chat",(e,r)=>{r.render("chat",{title:"Chat"})}),we.use((e,r,s,t)=>{if(!e.errors)return t(e);const o=Object.keys(e.errors);return o.length>0&&o.forEach(s=>r.flash("error",e.errors[s].message)),s.redirect("back")}),we.use((e,r,s,t)=>{const o=e.status||500;s.status(o).render("error",{status:o,message:e.message})});var ye=we;const ve=o()(),be=n.a.createServer(ve),ke=l()(be);U().catch(e=>console.error("Could not connect to DB",e.message)),ve.set("view engine","pug"),ve.set("trust proxy",!0),ve.use(J.a),ke.use((e,r)=>{Object(J.b)(e.handshake,{},r)}),ke.on("connection",e=>{console.log("New user connected"),W(e,ke)}),ve.use((e,r,s)=>{e.login=Object(c.promisify)(e.login.bind(e)),s()}),ve.use((e,r,s)=>{const t=e.flash();r.locals.user=e.user,r.locals.flashes=Object.keys(t).length>0?t:void 0,s()}),ve.use("/",ye);const Ee=process.env.PORT||4e3;be.listen(Ee,()=>{console.log(`Server started on port ${Ee}`)})},function(e,r){e.exports=require("connect-mongo")},function(e,r,s){e.exports=s(26)}]);
//# sourceMappingURL=server.bundle.js.map