!function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=29)}([function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("hbs")},function(e,t,r){"use strict";(function(e){r.d(t,"a",function(){return v}),r.d(t,"b",function(){return O});var s=r(2),n=r.n(s),o=r(26),a=r.n(o),i=r(25),c=r.n(i),u=r(4),l=r.n(u),d=r(24),m=r.n(d),p=r(3),g=r.n(p),f=r(10),h=(r(27),r(11)),w=r(16),y=r(12);const b=n()(),v=a.a.createServer(b),O=c()(v);Object(f.a)().catch(e=>console.error("Could not connect to DB",e.message)),l.a.localsAsTemplateData(b),l.a.registerHelper("toJSON",e=>JSON.stringify(e,null,2));const U=m()(l.a);U.registerPartials.bind(U)(g.a.join(e,"../views/partials"),{}),b.set("view engine","hbs"),b.use(w.a),O.on("connection",e=>{console.log("New user connected"),Object(h.a)(e,O)}),b.use((e,t,r)=>{const s=e.flash();t.locals.user=e.user,t.locals.flashes=Object.keys(s).length>0?s:void 0,r()}),b.use("/",y.a)}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,t){e.exports=require("express-validator/check")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("bcrypt")},function(e,t,r){"use strict";var s=r(1),n=r.n(s),o=r(9),a=r.n(o),i=r(23),c=r.n(i),u=r(22),l=r.n(u);const d=new n.a.Schema({email:{type:String,unique:"An account with email {VALUE} already exists",sparse:!0,trim:!0,lowercase:!0,validate:[c.a,"Email is not valid"]},password:{type:String,trim:!0,minlength:5},username:{type:String,required:"Username is required",unique:"Username already taken",sparse:!0,lowercase:!0,trim:!0,match:[/^[\w-]+$/,"Username must contain alphanumeric, '-', '_' characters only"]},facebookId:{type:String,unique:"An account with this Facebook already exists",sparse:!0},twitterId:{type:String,unique:"An account with this Twitter already exists",sparse:!0},googleId:{type:String,unique:"An account with this Google already exists",sparse:!0}});d.methods={hashPassword(e){if(!e)throw new Error("Password cannot be blank");return a.a.hash(e,12)},isValidPassword(e){return a.a.compare(e,this.password)}},d.pre("save",async function(e){this.password&&(this.password=await this.hashPassword(this.password)),e()}),d.plugin(l.a);n.a.model("User",d);t.a=(async()=>n.a.connect(process.env.DB_URL))},function(e,t,r){"use strict";var s=e=>"string"==typeof e&&e.trim().length>0,n=r(8),o=r.n(n);const a=(e,t)=>({from:e,text:t,createdAt:o()().valueOf()});const i=(()=>{let e;const t=()=>new class{constructor(){this.users=[]}addUser(e,t,r){const s={id:e,name:t,room:r};return this.users.push(s),s}removeUser(e){const t=Object.assign({},this.getUser({id:e}));return t&&(this.users=this.users.filter(e=>e.id!==t.id)),t}getUser({id:e,name:t}){return this.users.find(r=>r.id===e||r.name===t)}getUserList(e){return this.users.filter(t=>t.room===e).map(e=>e.name)}getRoomList(){return[...new Set(this.users.map(e=>e.room))]}};return{getInstance:()=>(e||(e=t()),e)}})().getInstance(),c=e=>{e.emit("updateRoomList",{rooms:i.getRoomList()})},u=(e,t)=>e.on("createLocationMessage",r=>{const s=i.getUser({id:e.id});s&&t.to(s.room).emit("newLocationMessage",((e,t,r)=>({from:e,url:`https://www.google.com/maps?q=${t},${r}`,createdAt:o()().valueOf()}))(s.name,r.latitude,r.longitude))});t.a=((e,t)=>({joinRoom:((e,t)=>e.on("join",(r,n)=>{if(!s(r.name)||!s(r.room))return n("Name and Room name are required!");const o=r.name.trim(),u=r.room.trim().toLowerCase(),l=i.getUser({name:o});return l&&l.room===u?n("Username taken!"):(e.join(u),i.removeUser(e.id),i.addUser(e.id,o,u),t.to(u).emit("updateUserList",i.getUserList(u)),e.emit("newMessage",a("Admin",`Welcome to the room ${u}!`)),e.broadcast.to(u).emit("newMessage",a("Admin",`${o} joined the chat`)),c(t),n())}))(e,t),createMessage:((e,t)=>e.on("createMessage",(r,n)=>{const o=i.getUser({id:e.id});o&&s(r.text)&&t.to(o.room).emit("newMessage",a(o.name,r.text)),n()}))(e,t),createLocationMessage:u(e,t),disconnect:((e,t)=>e.on("disconnect",()=>{const r=i.removeUser(e.id);t.to(r.room).emit("updateUserList",i.getUserList(r.room)),t.to(r.room).emit("newMessage",a("Admin",`${r.name} has left`)),c(t)}))(e,t),getRoomList:(e=>e.on("getRoomList",(e,t)=>{t({rooms:i.getRoomList()})}))(e)}))},function(e,t,r){"use strict";var s=r(2),n=r.n(s),o=r(13),a=r(1),i=r.n(a),c=r(6);const u=e=>(t,r,s)=>e(t,r,s).catch(s),l=i.a.model("User"),d=[Object(c.checkSchema)({username:{in:"body",isLength:{errorMessage:"Username must not be empty",options:{min:1}},matches:{errorMessage:"Username must be letters, numbers, '_', '-' only",options:/^[\w-]+$/},trim:!0},email:{in:"body",isEmail:{errorMessage:"Email address is not valid"},trim:!0,normalizeEmail:{options:{all_lowercase:!0,gmail_convert_googlemaildotcom:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0}}},password:{in:"body",isLength:{errorMessage:"Password must be at least 5 characters long",options:{min:5}},trim:!0},"password-confirm":{in:"body",custom:{options:(e,{req:t})=>{if(t.body.password!==e)throw new Error("Password confirmation does not match password field");return!0}}}}),(e,t,r)=>{const s=Object(c.validationResult)(e).formatWith(({msg:e})=>e);s.isEmpty()?r():(e.flash("error",s.array({onlyFirstError:!0})),t.render("signup",{body:e.body,flashes:e.flash()}))}];var m={createOne:async(e,t,r)=>{const{email:s,password:n,username:o}=e.body,a=new l({email:s,password:n,username:o});try{await a.save(),e.login(a,r),e.flash("success","New account created!"),t.redirect("/")}catch(n){if(n.errors){const r=Object.keys(n.errors).map(e=>n.errors[e].message);e.flash("error",r),t.render("signup",{body:{username:o,email:s},flashes:e.flash()})}else r(n)}},getOne:u(async(e,t)=>{const r=await l.findById(e.user.id);t.send(`get user\n ${r}`)}),updateOne:u((e,t)=>{t.send(`update user\n ${e.docFromId}`)}),deleteOne:u((e,t)=>{t.send(`delete user\n ${e.docFromId}`)}),signupForm:(e,t)=>{t.render("signup")},validateNewUser:d};const p=n.a.Router(),g=i.a.model("User");p.param("id",async(e,t,r,s)=>{try{if(!i.a.Types.ObjectId.isValid(s))throw new Error("Invalid user id");const t=await g.findById(s);if(!t)throw new Error("No user found");e.docFromId=t,r()}catch(e){r(e.message)}}),p.route("/signup").get(m.signupForm).post(m.validateNewUser,m.createOne),p.route("/user/:id").get(Object(o.ensureLoggedIn)(),m.getOne).put(m.updateOne).delete(m.deleteOne);var f=r(0),h=r.n(f);var w={loginForm:(e,t)=>{t.render("login")},loginUser:h.a.authenticate("local",{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:!0,successFlash:!0}),logoutUser:(e,t)=>{e.logout(),e.flash("info","You have logged out"),t.redirect("/")},genOauthLogin:(e,t)=>({requestPermission:()=>t.scope?h.a.authenticate(e,{scope:t.scope}):h.a.authenticate(e),callback:h.a.authenticate(e,{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:`Permission to login with ${e[0].toUpperCase()+e.substring(1).toLowerCase()} was denied`,successFlash:!0})})};const y=n.a.Router();y.get("/login",w.loginForm),y.post("/login",w.loginUser),y.get("/logout",w.logoutUser),[{provider:"facebook"},{provider:"twitter"},{provider:"google",config:{scope:"https://www.googleapis.com/auth/userinfo.profile"}}].forEach(({provider:e,config:t={}})=>{const{requestPermission:r,callback:s}=w.genOauthLogin(e,t);y.get(`/login/${e}`,r()),y.get(`/login/${e}/callback`,s)});const b=n.a.Router();b.use("/",y),b.use("/",p),b.get("/",(e,t)=>{t.render("index",{title:"Join"})}),b.post("/chat",(e,t)=>{t.render("chat",{title:"Chat"})}),b.use((e,t,r,s)=>{if(!e.errors)return s(e);const n=Object.keys(e.errors);return n.length>0&&n.forEach(r=>t.flash("error",e.errors[r].message)),r.redirect("back")}),b.use((e,t,r,s)=>{r.status(500).send(`something messed up: ${e.message}`)});t.a=b},function(e,t){e.exports=require("connect-ensure-login")},function(e,t){e.exports=require("connect-flash")},function(e,t){e.exports=require("express-session")},function(e,t,r){"use strict";(function(e){var s=r(2),n=r.n(s),o=r(3),a=r.n(o),i=r(7),c=r.n(i),u=r(0),l=r.n(u),d=r(15),m=r.n(d),p=r(14),g=r.n(p);t.a=[n.a.static(a.a.join(e,"../public")),c.a.json(),c.a.urlencoded({extended:!0}),m()({secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!1}),l.a.initialize(),l.a.session(),g()()]}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("passport-google-oauth")},function(e,t){e.exports=require("passport-twitter")},function(e,t){e.exports=require("passport-facebook")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("mongoose-beautiful-unique-validation")},function(e,t){e.exports=require("validator/lib/isEmail")},function(e,t){e.exports=require("hbs-utils")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("http")},function(e,t,r){"use strict";var s=r(0),n=r.n(s),o=r(21),a=r.n(o),i=r(20),c=r.n(i),u=r(19),l=r.n(u),d=r(18),m=r(1),p=r.n(m),g=r(17),f=r.n(g);const h=p.a.model("User");n.a.use(new a.a({usernameField:"email"},async(e,t,r)=>{try{const s=await h.findOne({email:e});return s&&await s.isValidPassword(t)?r(null,s,{message:`You have logged in, ${s.username}`}):r(null,!1,{message:"User or password is invalid"})}catch(e){return r(e,null,{message:"Could not authenticate. Please try again"})}}));const w=async e=>{const t=e.toLowerCase().replace(/ /g,"_"),r=new RegExp(`^${t}d*$`),s=await h.find({username:r},"username");let n=t;for(let e=0;f.a.find(s,{username:n});e+=1)n=t+(s.length+e);return n},y=e=>async(t,r,s,n)=>{try{let t=await h.findOne({[`${e}Id`]:s.id});return n(null,t?t:t=await h.create({[`${e}Id`]:s.id,username:await w(s.username||s.displayName)}),{message:`You have logged in, ${t.username}`})}catch(e){return n(e,!1,{message:"Could not authenticate. Please try again"})}};n.a.use(new c.a({clientID:process.env.FACEBOOK_APP_ID,clientSecret:process.env.FACEBOOK_APP_SECRET,callbackURL:`${process.env.DOMAIN}/login/facebook/callback`},y("facebook"))),n.a.use(new l.a({consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,callbackURL:`${process.env.DOMAIN}/login/twitter/callback`},async(e,t,r,s)=>{try{let e=await h.findOne({twitterId:r.id});return s(null,e?e:e=await h.create({twitterId:r.id,username:await w(r.username)}),{message:`You have logged in, ${e.username}`})}catch(e){return s(e,!1,{message:"Could not authenticate. Please try again"})}})),n.a.use(new d.OAuth2Strategy({clientID:process.env.GOOGLE_APP_ID,clientSecret:process.env.GOOGLE_APP_SECRET,callbackURL:`${process.env.DOMAIN}/login/google/callback`},y("google"))),n.a.serializeUser((e,t)=>t(null,e.id)),n.a.deserializeUser(async(e,t)=>{try{return t(null,await h.findById(e))}catch(e){return t(e)}})},function(e,t,r){"use strict";r.r(t);var s=r(5);const n=process.env.PORT||4e3;s.a,s.b;s.a.listen(n,()=>{console.log(`Server started on port ${n}`)})},function(e,t,r){e.exports=r(28)}]);
//# sourceMappingURL=server.bundle.js.map