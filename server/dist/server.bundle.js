!function(e){var r={};function s(t){if(r[t])return r[t].exports;var o=r[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=r,s.d=function(e,r,t){s.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:t})},s.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},s.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(r,"a",r),r},s.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},s.p="",s(s.s=19)}([function(e,r){e.exports=require("mongoose")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("passport")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("hbs")},function(e,r){e.exports=require("express-validator/check")},function(e,r){e.exports=require("body-parser")},function(e,r){e.exports=require("moment")},function(e,r){e.exports=require("bcrypt")},function(e,r){e.exports=require("connect-ensure-login")},function(e,r){e.exports=require("connect-flash")},function(e,r){e.exports=require("express-session")},function(e,r){e.exports=require("passport-local")},function(e,r){e.exports=require("mongoose-beautiful-unique-validation")},function(e,r){e.exports=require("validator/lib/isEmail")},function(e,r){e.exports=require("hbs-utils")},function(e,r){e.exports=require("socket.io")},function(e,r){e.exports=require("http")},function(e,r,s){"use strict";s.r(r);var t=s(1),o=s.n(t),n=s(17),a=s.n(n),i=s(16),u=s.n(i),c=s(4),l=s.n(c),d=s(15),m=s.n(d),g=s(3),p=s.n(g),h=s(0),f=s.n(h);var w=()=>f.a.connect(process.env.DB_URL),y=s(8),v=s.n(y),b=s(14),U=s.n(b),x=s(13),q=s.n(x);const O=new f.a.Schema({email:{type:String,required:"You must supply a email",unique:"An account with email {VALUE} already exists",trim:!0,lowercase:!0,validate:[U.a,"Email is not valid"]},password:{type:String,required:"You must supply a password",trim:!0,minlength:5},username:{type:String,required:"Username is required",unique:"Username already taken",trim:!0}});O.methods={hashPassword(e){if(!e)throw new Error("Password cannot be blank");return v.a.hash(e,12)},isValidPassword(e){return v.a.compare(e,this.password)}},O.pre("save",async function(e){this.password=await this.hashPassword(this.password),e()}),O.plugin(q.a);f.a.model("User",O);var L=s(2),j=s.n(L),R=s(12),_=s.n(R);const E=f.a.model("User");j.a.use(new _.a({usernameField:"email"},async(e,r,s)=>{try{const t=await E.findOne({email:e});return t&&await t.isValidPassword(r)?s(null,t,{message:`You have logged in, ${t.username}`}):s(null,!1,{message:"User or password is invalid"})}catch(e){return s(e,null,{message:"Could not authenticate. Please try again"})}})),j.a.serializeUser((e,r)=>r(null,e.id)),j.a.deserializeUser(async(e,r)=>{try{return r(null,await E.findById(e))}catch(e){return r(e)}});var M=e=>"string"==typeof e&&e.trim().length>0,S=s(7),P=s.n(S);const I=(e,r)=>({from:e,text:r,createdAt:P()().valueOf()});const F=(()=>{let e;const r=()=>new class{constructor(){this.users=[]}addUser(e,r,s){const t={id:e,name:r,room:s};return this.users.push(t),t}removeUser(e){const r=Object.assign({},this.getUser({id:e}));return r&&(this.users=this.users.filter(e=>e.id!==r.id)),r}getUser({id:e,name:r}){return this.users.find(s=>s.id===e||s.name===r)}getUserList(e){return this.users.filter(r=>r.room===e).map(e=>e.name)}getRoomList(){return[...new Set(this.users.map(e=>e.room))]}};return{getInstance:()=>(e||(e=r()),e)}})().getInstance(),$=e=>{e.emit("updateRoomList",{rooms:F.getRoomList()})},k=(e,r)=>e.on("createLocationMessage",s=>{const t=F.getUser({id:e.id});t&&r.to(t.room).emit("newLocationMessage",((e,r,s)=>({from:e,url:`https://www.google.com/maps?q=${r},${s}`,createdAt:P()().valueOf()}))(t.name,s.latitude,s.longitude))});var A=(e,r)=>({joinRoom:((e,r)=>e.on("join",(s,t)=>{if(!M(s.name)||!M(s.room))return t("Name and Room name are required!");const o=s.name.trim(),n=s.room.trim().toLowerCase(),a=F.getUser({name:o});return a&&a.room===n?t("Username taken!"):(e.join(n),F.removeUser(e.id),F.addUser(e.id,o,n),r.to(n).emit("updateUserList",F.getUserList(n)),e.emit("newMessage",I("Admin",`Welcome to the room ${n}!`)),e.broadcast.to(n).emit("newMessage",I("Admin",`${o} joined the chat`)),$(r),t())}))(e,r),createMessage:((e,r)=>e.on("createMessage",(s,t)=>{const o=F.getUser({id:e.id});o&&M(s.text)&&r.to(o.room).emit("newMessage",I(o.name,s.text)),t()}))(e,r),createLocationMessage:k(e,r),disconnect:((e,r)=>e.on("disconnect",()=>{const s=F.removeUser(e.id);r.to(s.room).emit("updateUserList",F.getUserList(s.room)),r.to(s.room).emit("newMessage",I("Admin",`${s.name} has left`)),$(r)}))(e,r),getRoomList:(e=>e.on("getRoomList",(e,r)=>{r({rooms:F.getRoomList()})}))(e)}),N=s(6),B=s.n(N),C=s(11),T=s.n(C),z=s(10),V=s.n(z),Y=[o.a.static(p.a.join(__dirname,"../../public")),B.a.json(),B.a.urlencoded({extended:!0}),T()({secret:process.env.SESSION_SECRET}),j.a.initialize(),j.a.session(),V()()],D=s(9),J=s(5);const W=e=>(r,s,t)=>e(r,s,t).catch(t),H=f.a.model("User"),G=[Object(J.checkSchema)({username:{in:"body",isLength:{errorMessage:"Username must not be empty",options:{min:1}},isAlphanumeric:{errorMessage:"Username must be letters or numbers only"},trim:!0},email:{in:"body",isEmail:{errorMessage:"Email address is not valid"},trim:!0,normalizeEmail:{options:{all_lowercase:!0,gmail_convert_googlemaildotcom:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0}}},password:{in:"body",isLength:{errorMessage:"Password must be at least 5 characters long",options:{min:5}},trim:!0},"password-confirm":{in:"body",custom:{options:(e,{req:r})=>{if(r.body.password!==e)throw new Error("Password confirmation does not match password field");return!0}}}}),(e,r,s)=>{const t=Object(J.validationResult)(e).formatWith(({msg:e})=>e);t.isEmpty()?s():(e.flash("error",t.array({onlyFirstError:!0})),r.render("signup",{body:e.body,flashes:e.flash()}))}];var K={createOne:async(e,r,s)=>{const{email:t,password:o,username:n}=e.body,a=new H({email:t,password:o,username:n});try{await a.save(),e.login(a,s),e.flash("success","New account created!"),r.redirect("/")}catch(o){if(o.errors){const s=Object.keys(o.errors).map(e=>o.errors[e].message);e.flash("error",s),r.render("signup",{body:{username:n,email:t},flashes:e.flash()})}else s(o)}},getOne:W(async(e,r)=>{const s=await H.findById(e.user.id);r.send(`get user\n ${s}`)}),updateOne:W((e,r)=>{r.send(`update user\n ${e.docFromId}`)}),deleteOne:W((e,r)=>{r.send(`delete user\n ${e.docFromId}`)}),signupForm:(e,r)=>{r.render("signup")},validateNewUser:G};const Q=o.a.Router(),X=f.a.model("User");Q.param("id",async(e,r,s,t)=>{try{if(!f.a.Types.ObjectId.isValid(t))throw new Error("Invalid user id");const r=await X.findById(t);if(!r)throw new Error("No user found");e.docFromId=r,s()}catch(e){s(e.message)}}),Q.route("/signup").get(K.signupForm).post(K.validateNewUser,K.createOne),Q.route("/user/:id").get(Object(D.ensureLoggedIn)(),K.getOne).put(K.updateOne).delete(K.deleteOne);var Z={loginForm:(e,r)=>{r.render("login")},loginUser:j.a.authenticate("local",{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:!0,successFlash:!0}),logoutUser:(e,r)=>{e.logout(),e.flash("info","You have logged out"),r.redirect("/")}};const ee=o.a.Router();ee.get("/login",Z.loginForm),ee.post("/login",Z.loginUser),ee.get("/logout",Z.logoutUser);const re=o.a.Router();re.use("/",ee),re.use("/",Q),re.get("/",(e,r)=>{r.render("index",{title:"Join"})}),re.post("/chat",(e,r)=>{r.render("chat",{title:"Chat"})}),re.use((e,r,s,t)=>{if(!e.errors)return t(e);const o=Object.keys(e.errors);return o.length>0&&o.forEach(s=>r.flash("error",e.errors[s].message)),s.redirect("back")}),re.use((e,r,s,t)=>{s.status(500).send(`something messed up: ${e.message}`)});var se=re;const te=o()(),oe=a.a.createServer(te),ne=u()(oe);w().catch(e=>console.error("Could not connect to DB",e.message)),l.a.localsAsTemplateData(te),l.a.registerHelper("toJSON",e=>JSON.stringify(e,null,2));const ae=m()(l.a);ae.registerPartials.bind(ae)(p.a.join(__dirname,"../../views/partials"),{}),te.set("view engine","hbs"),te.use(Y),ne.on("connection",e=>{console.log("New user connected"),A(e,ne)}),te.use((e,r,s)=>{const t=e.flash();r.locals.user=e.user,r.locals.flashes=Object.keys(t).length>0?t:void 0,s()}),te.use("/",se);const ie=process.env.PORT||4e3;oe.listen(ie,()=>{console.log(`Server started on port ${ie}`)})},function(e,r,s){e.exports=s(18)}]);
//# sourceMappingURL=server.bundle.js.map