!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=30)}([function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-validator/check")},function(e,t){e.exports=require("hbs")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("path")},function(e,t,r){"use strict";(function(e){r.d(t,"a",function(){return O}),r.d(t,"b",function(){return U});var n=r(2),o=r.n(n),s=r(27),a=r.n(s),i=r(26),c=r.n(i),l=r(4),u=r.n(l),d=r(25),m=r.n(d),p=r(6),g=r.n(p),f=r(11),h=r.n(f),w=r(12),b=(r(28),r(13)),y=r(18),v=r(14);const k=o()(),O=a.a.createServer(k),U=c()(O);Object(w.a)().catch(e=>console.error("Could not connect to DB",e.message)),u.a.localsAsTemplateData(k),u.a.registerHelper("toJSON",e=>JSON.stringify(e,null,2)),u.a.registerHelper("linkedAccounts",e=>{let t="";const r=e.toObject(),n=e.accountsTotal()>1;return Object.entries(r).forEach(([e,r])=>{("local"===e&&r.email||r.token)&&(t+=`<tr><td>${e}</td>\n              <td>${"local"===e?r.email:r.username||r.displayName}\n              ${n?`<form method="post" action="/unlink/${e}"><button>Unlink</button></form>`:""}\n              </td></tr>`)}),new h.a.SafeString(t)}),u.a.registerHelper("linkableAccounts",e=>{const t=e.toObject(),r=["local","twitter","google","facebook"].filter(e=>!t[e]||"local"!==e&&!t[e].token);return new h.a.SafeString(r.map(e=>`<a class="linkButton" href="/link/${e}">${e}</a>`).join(""))});const S=m()(u.a);S.registerPartials.bind(S)(g.a.join(e,"../views/partials"),{}),k.set("view engine","hbs"),k.use(y.a),U.on("connection",e=>{console.log("New user connected"),Object(b.a)(e,U)}),k.use((e,t,r)=>{const n=e.flash();t.locals.user=e.user,t.locals.flashes=Object.keys(n).length>0?n:void 0,r()}),k.use("/",v.a)}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("handlebars")},function(e,t,r){"use strict";var n=r(1),o=r.n(n),s=r(10),a=r.n(s),i=r(24),c=r.n(i),l=r(23),u=r.n(l),d=r(5),m=r.n(d);const p=new o.a.Schema({username:{type:String,required:"Username is required",unique:"Username already taken",sparse:!0,lowercase:!0,trim:!0,match:[/^[\w-]+$/,"Username must contain alphanumeric, '-', '_' characters only"]},local:{email:{type:String,unique:"An account with email {VALUE} already exists",sparse:!0,trim:!0,lowercase:!0,validate:[c.a,"Email is not valid"]},password:{type:String,trim:!0,minlength:5}},facebook:{id:String,token:String,displayName:String,email:String},twitter:{id:String,token:String,displayName:String,username:String},google:{id:String,token:String,displayName:String,email:String}});p.methods.isValidPassword=function(e){return a.a.compare(e,this.local.password)};const g=["twitter","google","facebook","local"];p.methods.accountsTotal=function(){return Object.keys(this.toObject()).reduce((e,t)=>g.includes(t)&&("local"===t||"local"!==t&&this[t].token)?e+1:e,0)},p.statics.hashPassword=function(e){if(!e)throw new Error("Password cannot be blank");return a.a.hash(e,12)},p.statics.genUniqueUsername=async function(e="anon"){const t=e.toLowerCase().replace(/ /g,"_"),r=new RegExp(`^${t}d*$`),n=await this.find({username:r},"username");let o=t;for(let e=0;m.a.find(n,{username:o});e+=1)o=t+(n.length+e);return o},p.plugin(u.a);o.a.model("User",p);t.a=(async()=>o.a.connect(process.env.DB_URL))},function(e,t,r){"use strict";var n=e=>"string"==typeof e&&e.trim().length>0,o=r(9),s=r.n(o);const a=(e,t)=>({from:e,text:t,createdAt:s()().valueOf()});const i=(()=>{let e;const t=()=>new class{constructor(){this.users=[]}addUser(e,t,r){const n={id:e,name:t,room:r};return this.users.push(n),n}removeUser(e){const t=Object.assign({},this.getUser({id:e}));return t&&(this.users=this.users.filter(e=>e.id!==t.id)),t}getUser({id:e,name:t}){return this.users.find(r=>r.id===e||r.name===t)}getUserList(e){return this.users.filter(t=>t.room===e).map(e=>e.name)}getRoomList(){return[...new Set(this.users.map(e=>e.room))]}};return{getInstance:()=>(e||(e=t()),e)}})().getInstance(),c=e=>{e.emit("updateRoomList",{rooms:i.getRoomList()})},l=(e,t)=>e.on("createLocationMessage",r=>{const n=i.getUser({id:e.id});n&&t.to(n.room).emit("newLocationMessage",((e,t,r)=>({from:e,url:`https://www.google.com/maps?q=${t},${r}`,createdAt:s()().valueOf()}))(n.name,r.latitude,r.longitude))});t.a=((e,t)=>({joinRoom:((e,t)=>e.on("join",(r,o)=>{if(!n(r.name)||!n(r.room))return o("Name and Room name are required!");const s=r.name.trim(),l=r.room.trim().toLowerCase(),u=i.getUser({name:s});return u&&u.room===l?o("Username taken!"):(e.join(l),i.removeUser(e.id),i.addUser(e.id,s,l),t.to(l).emit("updateUserList",i.getUserList(l)),e.emit("newMessage",a("Admin",`Welcome to the room ${l}!`)),e.broadcast.to(l).emit("newMessage",a("Admin",`${s} joined the chat`)),c(t),o())}))(e,t),createMessage:((e,t)=>e.on("createMessage",(r,o)=>{const s=i.getUser({id:e.id});s&&n(r.text)&&t.to(s.room).emit("newMessage",a(s.name,r.text)),o()}))(e,t),createLocationMessage:l(e,t),disconnect:((e,t)=>e.on("disconnect",()=>{const r=i.removeUser(e.id);t.to(r.room).emit("updateUserList",i.getUserList(r.room)),t.to(r.room).emit("newMessage",a("Admin",`${r.name} has left`)),c(t)}))(e,t),getRoomList:(e=>e.on("getRoomList",(e,t)=>{t({rooms:i.getRoomList()})}))(e)}))},function(e,t,r){"use strict";var n=r(2),o=r.n(n),s=r(15),a=r(1),i=r.n(a),c=r(3),l=r(5),u=r.n(l);var d=(...e)=>{const t={username:{in:"body",isLength:{errorMessage:"Username must not be empty",options:{min:1}},matches:{errorMessage:"Username must be letters, numbers, '_', '-' only",options:/^[\w-]+$/},trim:!0},email:{in:"body",isEmail:{errorMessage:"Email address is not valid"},trim:!0,normalizeEmail:{options:{all_lowercase:!0,gmail_convert_googlemaildotcom:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0}}},password:{in:"body",isLength:{errorMessage:"Password must be at least 5 characters long",options:{min:5}},trim:!0},"password-confirm":{in:"body",custom:{options:(e,{req:t})=>{if(t.body.password!==e)throw new Error("Password confirmation does not match password field");return!0}}}};return e?u.a.pick(t,e):t};const m=e=>(t,r,n)=>e(t,r,n).catch(n),p=i.a.model("User"),g=[Object(c.checkSchema)(d()),(e,t,r)=>{const n=Object(c.validationResult)(e).formatWith(({msg:e})=>e);n.isEmpty()?r():(e.flash("error",n.array({onlyFirstError:!0})),t.render("signup",{body:e.body,flashes:e.flash()}))}];var f={createOne:async(e,t,r)=>{const{email:n,password:o,username:s}=e.body;try{const a=new p({local:{email:n,password:await p.hashPassword(o)},username:s});await a.save(),e.login(a,r),e.flash("success","New account created!"),t.redirect("/")}catch(o){if(o.errors){const r=Object.keys(o.errors).map(e=>o.errors[e].message);e.flash("error",r),t.render("signup",{body:{username:s,email:n},flashes:e.flash()})}else r(o)}},getOne:m(async(e,t)=>{const r=await p.findById(e.user.id);t.send(`get user\n ${r}`)}),updateOne:m((e,t)=>{t.send(`update user\n ${e.docFromId}`)}),deleteOne:m((e,t)=>{t.send(`delete user\n ${e.docFromId}`)}),signupForm:(e,t)=>{t.render("signup")},validateNewUser:g};const h=o.a.Router(),w=i.a.model("User");h.param("id",async(e,t,r,n)=>{try{if(!i.a.Types.ObjectId.isValid(n))throw new Error("Invalid user id");const t=await w.findById(n);if(!t)throw new Error("No user found");e.docFromId=t,r()}catch(e){r(e.message)}}),h.route("/signup").get(f.signupForm).post(f.validateNewUser,f.createOne),h.route("/user/:id").get(Object(s.ensureLoggedIn)(),f.getOne).put(f.updateOne).delete(f.deleteOne);var b=r(0),y=r.n(b);const v=i.a.model("User");var k={loginForm:(e,t)=>t.render("login"),loginUser:y.a.authenticate("local",{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:"Email or password is invalid",successFlash:"You have logged in"}),logoutUser:(e,t)=>{e.logout(),e.flash("info","You have logged out"),t.redirect("/")},genOauthLogin:(e,t={})=>({auth:(r,n,o)=>(r.user?y.a.authorize:y.a.authenticate).call(y.a,e,t.scope&&{scope:t.scope})(r,n,o),authCb(t,r,n){const o=t.user?y.a.authorize:y.a.authenticate,s=t.user?{failureRedirect:"/profile",failureFlash:`${e} account was not linked`}:(o,s,a)=>o?n(o):s?t.login(s,o=>o?n(o):(t.flash("success",`You have logged in, ${s[e].displayName||s[e].username}`),a.firstLogin?r.redirect("/profile"):r.redirect("/"))):(t.flash("error",`Permission to login via ${e} was denied`),r.redirect("/login"));return o.call(y.a,e,s)(t,r,n)}}),profile:async(e,t)=>{t.render("profile",{body:{username:e.user.username}})},authLocal:y.a.authorize("local",{failureRedirect:"/link/local",failureFlash:"Email or password is invalid"}),linkAccount:async(e,t,r)=>{const{user:n,account:o}=e;if(n&&o){const r=o.toObject({transform(e,t){const r=Object.assign({},t);return delete r.__v,delete r._id,r}});return r.local&&await v.deleteOne({"local.email":r.local.email}),Object.assign(n,r,{username:n.username}),await n.save(),await o.remove(),e.flash("success","Accounts have been linked"),t.redirect("/profile")}return r()},unlinkAccount:async(e,t,r)=>{const n=e.params.account,{user:o}=e;if(!["twitter","google","facebook","local"].includes(n)){const e=new Error("Unknown account type");return e.status=400,r(e)}if(1===o.accountsTotal)return e.flash("error","Unable to unlink solo account"),t.redirect("/profile");if("local"===n){const e=Object.assign({},o.local);o.local=void 0,await o.save(),await v.create({local:e,username:await v.genUniqueUsername()})}else o[n].token=void 0,await o.save();e.flash("success","Account has been unlinked"),t.redirect("/profile")},linkLocalForm:(e,t)=>t.render("link_local"),validateProfile:[Object(c.checkSchema)(d("username")),(e,t,r)=>{const n=Object(c.validationResult)(e).formatWith(({msg:e})=>e);n.isEmpty()?r():(e.flash("error",n.array({onlyFirstError:!0})),t.render("profile",{body:e.body,flashes:e.flash()}))}],updateProfile:async(e,t)=>{e.user.username=e.body.username,await e.user.save(),e.flash("success","Username updated"),t.redirect("/profile")}};const O=(e,t,r)=>{e.isAuthenticated()?r():t.redirect("/")},U=o.a.Router();U.get("/login",k.loginForm),U.post("/login",k.loginUser),U.get("/logout",O,k.logoutUser),U.get("/profile",O,m(k.profile)),U.post("/profile",O,k.validateProfile,m(k.updateProfile)),U.get("/link/local",O,k.linkLocalForm),U.post("/link/local",O,k.authLocal,m(k.linkAccount)),U.post("/unlink/:account",O,m(k.unlinkAccount)),[{provider:"facebook",config:{scope:"email"}},{provider:"twitter"},{provider:"google",config:{scope:"https://www.googleapis.com/auth/userinfo.profile"}}].forEach(({provider:e,config:t})=>{const{auth:r,authCb:n}=k.genOauthLogin(e,t);U.get(`/auth/${e}`,r),U.get(`/auth/${e}/callback`,n,m(k.linkAccount)),U.get(`/link/${e}`,O,r)});const S=o.a.Router();S.use("/",U),S.use("/",h),S.get("/",(e,t)=>{t.render("index",{title:"Join"})}),S.post("/chat",(e,t)=>{t.render("chat",{title:"Chat"})}),S.use((e,t,r,n)=>{if(!e.errors)return n(e);const o=Object.keys(e.errors);return o.length>0&&o.forEach(r=>t.flash("error",e.errors[r].message)),r.redirect("back")}),S.use((e,t,r,n)=>{const o=e.status||500;r.status(o).render("error",{status:o,message:e.message})});t.a=S},function(e,t){e.exports=require("connect-ensure-login")},function(e,t){e.exports=require("connect-flash")},function(e,t){e.exports=require("express-session")},function(e,t,r){"use strict";(function(e){var n=r(2),o=r.n(n),s=r(6),a=r.n(s),i=r(8),c=r.n(i),l=r(0),u=r.n(l),d=r(17),m=r.n(d),p=r(16),g=r.n(p);t.a=[o.a.static(a.a.join(e,"../public")),c.a.json(),c.a.urlencoded({extended:!0}),m()({secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!1}),u.a.initialize(),u.a.session(),g()()]}).call(this,"/Users/tim/Work/misc/complete-node/node-chat-app/server")},function(e,t){e.exports=require("passport-google-oauth")},function(e,t){e.exports=require("passport-twitter")},function(e,t){e.exports=require("passport-facebook")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("mongoose-beautiful-unique-validation")},function(e,t){e.exports=require("validator/lib/isEmail")},function(e,t){e.exports=require("hbs-utils")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("http")},function(e,t,r){"use strict";var n=r(0),o=r.n(n),s=r(22),a=r.n(s),i=r(21),c=r.n(i),l=r(20),u=r.n(l),d=r(19),m=r(1),p=r.n(m);r(5);const g=p.a.model("User");o.a.use(new a.a({usernameField:"email",passReqToCallback:!0},async(e,t,r,n)=>{try{const e=await g.findOne({"local.email":t});return n(null,e?!!await e.isValidPassword(r)&&e:!1)}catch(e){return n(e,null,{message:"Could not authenticate. Please try again"})}}));const f=e=>e.emails&&e.emails.length&&e.emails[0].value,h=async(e,t,r)=>g.create({[e]:{id:r.id,displayName:r.displayName,token:t,email:f(r)},username:await g.genUniqueUsername(r.username||r.displayName)}),w=e=>async(t,r,n,o,s)=>{try{let n=await g.findOne({[`${e}.id`]:o.id});return t.user?n?(n[e].token||(n=await h(e,r,o)),s(null,n)):s(null,n=await h(e,r,o)):n?(n[e].token||(n[e]={id:o.id,displayName:o.displayName,token:r,email:f(o)},n=await n.save()),s(null,n)):s(null,n=await h(e,r,o),{firstLogin:!0})}catch(e){return s(e,!1,{message:"Could not authenticate. Please try again"})}};o.a.use(new c.a({clientID:process.env.FACEBOOK_APP_ID,clientSecret:process.env.FACEBOOK_APP_SECRET,callbackURL:`${process.env.DOMAIN}/auth/facebook/callback`,profileFields:["email","displayName"],passReqToCallback:!0},w("facebook"))),o.a.use(new u.a({consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,callbackURL:`${process.env.DOMAIN}/auth/twitter/callback`,passReqToCallback:!0},w("twitter"))),o.a.use(new d.OAuth2Strategy({clientID:process.env.GOOGLE_APP_ID,clientSecret:process.env.GOOGLE_APP_SECRET,callbackURL:`${process.env.DOMAIN}/auth/google/callback`,passReqToCallback:!0},w("google"))),o.a.serializeUser((e,t)=>t(null,e.id)),o.a.deserializeUser(async(e,t)=>{try{return t(null,await g.findById(e))}catch(e){return t(e)}})},function(e,t,r){"use strict";r.r(t);var n=r(7);const o=process.env.PORT||4e3;n.a,n.b;n.a.listen(o,()=>{console.log(`Server started on port ${o}`)})},function(e,t,r){e.exports=r(29)}]);
//# sourceMappingURL=server.bundle.js.map