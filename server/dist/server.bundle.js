!function(e){var t={};function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=17)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("hbs")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("connect-ensure-login")},function(e,t){e.exports=require("connect-flash")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("mongoose-beautiful-unique-validation")},function(e,t){e.exports=require("validator/lib/isEmail")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("http")},function(e,t,r){"use strict";r.r(t);var s=r(1),o=r.n(s),n=r(15),a=r.n(n),i=r(14),u=r.n(i),c=r(4),d=r.n(c),l=r(3),m=r.n(l),g=r(0),p=r.n(g);var f=()=>p.a.connect("mongodb://127.0.0.1:27017/node-chat-app"),h=r(7),w=r.n(h),v=r(13),y=r.n(v),U=r(12),x=r.n(U);const q=new p.a.Schema({email:{type:String,required:"You must supply a email",unique:"An account with email {VALUE} already exists",trim:!0,lowercase:!0,validate:[y.a,"Email is not valid"]},password:{type:String,required:"You must supply a password",trim:!0,minlength:5},username:{type:String,required:"Username is required",unique:"Username already taken",trim:!0}});q.methods={hashPassword(e){if(!e)throw new Error("Password cannot be blank");return w.a.hash(e,12)},isValidPassword(e){return w.a.compare(e,this.password)}},q.pre("save",async function(e){this.password=await this.hashPassword(this.password),e()}),q.plugin(x.a);p.a.model("User",q);var b=r(2),O=r.n(b),L=r(11),R=r.n(L);const j=p.a.model("User");O.a.use(new R.a({usernameField:"email"},async(e,t,r)=>{try{const s=await j.findOne({email:e});return s&&await s.isValidPassword(t)?r(null,s,{message:`You have logged in, ${s.username}`}):r(null,!1,{message:"User or password is invalid"})}catch(e){return r(e,null,{message:"Could not authenticate. Please try again"})}})),O.a.serializeUser((e,t)=>t(null,e.id)),O.a.deserializeUser(async(e,t)=>{try{return t(null,await j.findById(e))}catch(e){return t(e)}});var I=e=>"string"==typeof e&&e.trim().length>0,M=r(6),P=r.n(M);const $=(e,t)=>({from:e,text:t,createdAt:P()().valueOf()});const F=(()=>{let e;const t=()=>new class{constructor(){this.users=[]}addUser(e,t,r){const s={id:e,name:t,room:r};return this.users.push(s),s}removeUser(e){const t=Object.assign({},this.getUser({id:e}));return t&&(this.users=this.users.filter(e=>e.id!==t.id)),t}getUser({id:e,name:t}){return this.users.find(r=>r.id===e||r.name===t)}getUserList(e){return this.users.filter(t=>t.room===e).map(e=>e.name)}getRoomList(){return[...new Set(this.users.map(e=>e.room))]}};return{getInstance:()=>(e||(e=t()),e)}})().getInstance(),S=e=>{e.emit("updateRoomList",{rooms:F.getRoomList()})},A=(e,t)=>e.on("createLocationMessage",r=>{const s=F.getUser({id:e.id});s&&t.to(s.room).emit("newLocationMessage",((e,t,r)=>({from:e,url:`https://www.google.com/maps?q=${t},${r}`,createdAt:P()().valueOf()}))(s.name,r.latitude,r.longitude))});var N=(e,t)=>({joinRoom:((e,t)=>e.on("join",(r,s)=>{if(!I(r.name)||!I(r.room))return s("Name and Room name are required!");const o=r.name.trim(),n=r.room.trim().toLowerCase(),a=F.getUser({name:o});return a&&a.room===n?s("Username taken!"):(e.join(n),F.removeUser(e.id),F.addUser(e.id,o,n),t.to(n).emit("updateUserList",F.getUserList(n)),e.emit("newMessage",$("Admin",`Welcome to the room ${n}!`)),e.broadcast.to(n).emit("newMessage",$("Admin",`${o} joined the chat`)),S(t),s())}))(e,t),createMessage:((e,t)=>e.on("createMessage",(r,s)=>{const o=F.getUser({id:e.id});o&&I(r.text)&&t.to(o.room).emit("newMessage",$(o.name,r.text)),s()}))(e,t),createLocationMessage:A(e,t),disconnect:((e,t)=>e.on("disconnect",()=>{const r=F.removeUser(e.id);t.to(r.room).emit("updateUserList",F.getUserList(r.room)),t.to(r.room).emit("newMessage",$("Admin",`${r.name} has left`)),S(t)}))(e,t),getRoomList:(e=>e.on("getRoomList",(e,t)=>{t({rooms:F.getRoomList()})}))(e)}),_=r(5),k=r.n(_),E=r(10),B=r.n(E),C=r(9),T=r.n(C),V=[o.a.static(m.a.join(__dirname,"../../public")),k.a.json(),k.a.urlencoded({extended:!0}),B()({secret:"keyboard cat"}),O.a.initialize(),O.a.session(),T()()],Y=r(8);const z=e=>(t,r,s)=>e(t,r,s).catch(s),J=p.a.model("User");var D={createOne:z(async(e,t,r)=>{const{email:s,password:o,username:n}=e.body,a=new J({email:s,password:o,username:n});await a.save(),e.login(a,r),e.flash("success","New account created!"),t.redirect("/")}),getOne:z(async(e,t)=>{const r=await J.findById(e.user.id);t.send(`get user\n ${r}`)}),updateOne:z((e,t)=>{t.send(`update user\n ${e.docFromId}`)}),deleteOne:z((e,t)=>{t.send(`delete user\n ${e.docFromId}`)}),signupForm:(e,t)=>{t.render("signup")},validateNewUser:(e,t)=>{}};const H=o.a.Router(),W=p.a.model("User");H.param("id",async(e,t,r,s)=>{try{if(!p.a.Types.ObjectId.isValid(s))throw new Error("Invalid user id");const t=await W.findById(s);if(!t)throw new Error("No user found");e.docFromId=t,r()}catch(e){r(e.message)}}),H.route("/signup").get(D.signupForm).post(D.validateNewUser,D.createOne),H.route("/user/:id").get(Object(Y.ensureLoggedIn)(),D.getOne).put(D.updateOne).delete(D.deleteOne);var G={loginForm:(e,t)=>{t.render("login")},loginUser:O.a.authenticate("local",{successReturnToOrRedirect:"/",failureRedirect:"/login",failureFlash:!0,successFlash:!0}),logoutUser:(e,t)=>{e.logout(),e.flash("info","You have logged out"),t.redirect("/")}};const K=o.a.Router();K.get("/login",G.loginForm),K.post("/login",G.loginUser),K.get("/logout",G.logoutUser);const Q=o.a.Router();Q.use("/",K),Q.use("/",H),Q.get("/",(e,t)=>{t.render("index",{title:"Join"})}),Q.post("/chat",(e,t)=>{t.render("chat",{title:"Chat"})}),Q.use((e,t,r,s)=>{if(!e.errors)return s(e);const o=Object.keys(e.errors);return o.length>0&&o.forEach(r=>t.flash("error",e.errors[r].message)),r.redirect("back")}),Q.use((e,t,r,s)=>{r.status(500).send(`something messed up: ${e.message}`)});var X=Q;const Z=o()(),ee=a.a.createServer(Z),te=u()(ee);f().catch(e=>console.error("Could not connect to DB",e.message)),d.a.localsAsTemplateData(Z),d.a.registerPartials(m.a.join(__dirname,"../../views/partials")),d.a.registerHelper("toJSON",e=>JSON.stringify(e,null,2)),Z.set("view engine","hbs"),Z.use(V),te.on("connection",e=>{console.log("New user connected"),N(e,te)}),Z.use((e,t,r)=>{t.locals.user=e.user,t.locals.flashes=e.flash(),r()}),Z.use("/",X);const re=process.env.PORT||3e3;ee.listen(re,()=>{console.log(`Server started on port ${re}`)})},function(e,t,r){e.exports=r(16)}]);
//# sourceMappingURL=server.bundle.js.map