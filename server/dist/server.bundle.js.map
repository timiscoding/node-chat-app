{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"mongoose\"","webpack:///external \"passport\"","webpack:///external \"express\"","webpack:///external \"express-validator/check\"","webpack:///external \"hbs\"","webpack:///external \"lodash\"","webpack:///external \"path\"","webpack:///./server/server.js","webpack:///./server/mailer.js","webpack:///external \"body-parser\"","webpack:///external \"moment\"","webpack:///external \"bcrypt\"","webpack:///external \"handlebars\"","webpack:///./server/models/user.model.js","webpack:///./server/models/emailVerifyToken.model.js","webpack:///./server/db.js","webpack:///./server/utils/validation.js","webpack:///./server/utils/message.js","webpack:///./server/socketEvent.js","webpack:///./server/utils/users.js","webpack:///./server/controllers/userValidatorSchema.js","webpack:///./server/utils/helpers.js","webpack:///./server/controllers/user.controller.js","webpack:///./server/routes/user.router.js","webpack:///./server/controllers/auth.controller.js","webpack:///./server/routes/auth.router.js","webpack:///./server/routes/index.js","webpack:///external \"crypto\"","webpack:///external \"connect-ensure-login\"","webpack:///external \"connect-flash\"","webpack:///external \"express-session\"","webpack:///./server/middleware.js","webpack:///external \"nodemailer\"","webpack:///external \"passport-google-oauth\"","webpack:///external \"passport-twitter\"","webpack:///external \"passport-facebook\"","webpack:///external \"passport-local\"","webpack:///external \"mongoose-beautiful-unique-validation\"","webpack:///external \"validator/lib/isEmail\"","webpack:///external \"es6-promisify\"","webpack:///external \"hbs-utils\"","webpack:///external \"socket.io\"","webpack:///external \"http\"","webpack:///./server/passport.js","webpack:///./server/index.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","_routes__WEBPACK_IMPORTED_MODULE_13__","app","express__WEBPACK_IMPORTED_MODULE_0___default","server","http__WEBPACK_IMPORTED_MODULE_1___default","a","createServer","io","socket_io__WEBPACK_IMPORTED_MODULE_2___default","_db__WEBPACK_IMPORTED_MODULE_8__","catch","err","console","error","message","hbs__WEBPACK_IMPORTED_MODULE_3___default","localsAsTemplateData","registerHelper","obj","JSON","stringify","user","out","accounts","toObject","canUnlink","accountsTotal","entries","forEach","type","acc","email","token","username","displayName","handlebars__WEBPACK_IMPORTED_MODULE_6___default","SafeString","linkable","filter","map","join","hbsUtils","hbs_utils__WEBPACK_IMPORTED_MODULE_4___default","registerPartials","hbsRegisterPartials","path__WEBPACK_IMPORTED_MODULE_5___default","__dirname","set","use","_middleware__WEBPACK_IMPORTED_MODULE_12__","on","socket","log","_socketEvent__WEBPACK_IMPORTED_MODULE_11__","req","res","next","login","es6_promisify__WEBPACK_IMPORTED_MODULE_7__","flashes","flash","locals","keys","length","undefined","options","port","process","env","MAILER_PORT","host","MAILER_HOST","auth","MAILER_USERNAME","pass","MAILER_PASSWORD","transporter","nodemailer__WEBPACK_IMPORTED_MODULE_0___default","createTransport","verify","sendMail","to","subject","text","html","from","userSchema","external_mongoose_default","Schema","String","required","unique","sparse","lowercase","trim","match","local","validate","isEmail_default","password","minlength","isVerified","Boolean","default","facebook","id","twitter","google","methods","isValidPassword","external_bcrypt_default","compare","this","types","reduce","total","f","includes","statics","hashPassword","plaintextPassword","Error","hash","genUniqueUsername","async","snakeCase","toLowerCase","replace","usernameRegex","RegExp","usernames","find","newUsername","external_lodash_default","plugin","external_mongoose_beautiful_unique_validation_default","model","emailVerifyTokenSchema","Types","ObjectId","ref","createdAt","Date","expires","now","__webpack_exports__","connect","DB_URL","validation","string","generateMessage","external_moment_default","valueOf","socketEvent_users","instance","createInstance","[object Object]","users","room","push","userToRemove","assign","getUser","Set","getInstance","updateUserJoining","emit","rooms","getRoomList","createLocationMessage","coords","latitude","longitude","url","generateLocationMessage","joinRoom","params","callback","removeUser","addUser","getUserList","broadcast","createMessage","disconnect","_","controllers_userValidatorSchema","fields","schema","in","isLength","errorMessage","min","matches","isEmail","normalizeEmail","all_lowercase","gmail_convert_googlemaildotcom","gmail_remove_dots","gmail_remove_subaddress","password-confirm","custom","body","pick","catchAsyncError","fn","User","EmailVerifyToken","validateNewUser","check_","errors","formatWith","msg","isEmpty","array","onlyFirstError","render","createOne","emailToken","external_crypto_default","randomBytes","toString","verifyURL","protocol","hostname","mailer","redirect","getOne","findById","send","updateOne","docFromId","deleteOne","signupForm","confirmEmail","findOneAndRemove","populate","save","userRouter","external_express_default","Router","user_router_User","param","isValid","route","user_controller","post","external_connect_ensure_login_","put","delete","auth_controller_User","auth_controller","loginForm","loginUser","external_passport_default","authenticate","successReturnToOrRedirect","failureRedirect","failureFlash","successFlash","logoutUser","logout","genOauthLogin","provider","config","authorize","scope","routes","info","firstLogin","profile","authLocal","linkAccount","account","accountObj","doc","ret","newRet","__v","_id","local.email","remove","unlinkAccount","status","linkLocalForm","validateProfile","updateProfile","isLoggedIn","isAuthenticated","authRouter","authCb","routes_routes","title","validationErrors","e","static","path__WEBPACK_IMPORTED_MODULE_1___default","body_parser__WEBPACK_IMPORTED_MODULE_2___default","json","urlencoded","extended","express_session__WEBPACK_IMPORTED_MODULE_4___default","secret","SESSION_SECRET","resave","saveUninitialized","passport__WEBPACK_IMPORTED_MODULE_3___default","initialize","session","connect_flash__WEBPACK_IMPORTED_MODULE_5___default","mongoose__WEBPACK_IMPORTED_MODULE_5___default","passport__WEBPACK_IMPORTED_MODULE_0___default","passport_local__WEBPACK_IMPORTED_MODULE_1___default","usernameField","passReqToCallback","done","findOne","getEmail","emails","createAccount","genOauthCb","accessToken","refreshTokenOrSecret","passport_facebook__WEBPACK_IMPORTED_MODULE_2___default","clientID","FACEBOOK_APP_ID","clientSecret","FACEBOOK_APP_SECRET","callbackURL","DOMAIN","profileFields","passport_twitter__WEBPACK_IMPORTED_MODULE_3___default","consumerKey","TWITTER_CONSUMER_KEY","consumerSecret","TWITTER_CONSUMER_SECRET","passport_google_oauth__WEBPACK_IMPORTED_MODULE_4__","GOOGLE_APP_ID","GOOGLE_APP_SECRET","serializeUser","deserializeUser","_server__WEBPACK_IMPORTED_MODULE_0__","PORT","listen"],"mappings":"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","file":"server.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 34);\n","module.exports = require(\"mongoose\");","module.exports = require(\"passport\");","module.exports = require(\"express\");","module.exports = require(\"express-validator/check\");","module.exports = require(\"hbs\");","module.exports = require(\"lodash\");","module.exports = require(\"path\");","/* eslint-disable no-console */\n\nimport express from 'express';\nimport http from 'http';\nimport socketIO from 'socket.io';\nimport hbs from 'hbs';\nimport hbsUtilities from 'hbs-utils';\nimport path from 'path';\nimport Handlebars from 'handlebars';\nimport { promisify } from 'es6-promisify';\n\nimport connect from './db';\nimport './passport';\nimport './mailer';\nimport genSocketEvents from './socketEvent';\nimport globalMiddleware from './middleware';\nimport routes from './routes';\n\nconst app = express();\nconst server = http.createServer(app);\nconst io = socketIO(server);\nconnect().catch(err => console.error('Could not connect to DB', err.message));\n\nhbs.localsAsTemplateData(app);\nhbs.registerHelper('toJSON', obj => JSON.stringify(obj, null, 2));\nhbs.registerHelper('linkedAccounts', (user) => {\n  let out = '';\n  const accounts = user.toObject();\n  const canUnlink = user.accountsTotal() > 1;\n  Object.entries(accounts).forEach(([type, acc]) => {\n    if ((type === 'local' && acc.email) || acc.token) {\n      out += `<tr><td>${type}</td>\n              <td>${type === 'local' ? acc.email : acc.username || acc.displayName}\n              ${canUnlink ? `<form method=\"post\" action=\"/unlink/${type}\"><button>Unlink</button></form>` : ''}\n              </td></tr>`;\n    }\n  });\n  return new Handlebars.SafeString(out);\n});\nhbs.registerHelper('linkableAccounts', (user) => {\n  const accounts = user.toObject();\n  const accountTypes = ['local', 'twitter', 'google', 'facebook'];\n  const linkable = accountTypes.filter(type => !accounts[type] || (type !== 'local' && !accounts[type].token));\n  return new Handlebars.SafeString(linkable.map(type => `<a class=\"linkButton\" href=\"/link/${type}\">${type}</a>`).join(''));\n});\nconst hbsUtils = hbsUtilities(hbs);\nlet hbsRegisterPartials = hbsUtils.registerPartials.bind(hbsUtils);\nlet hbsRegisterPartialsOpt = {};\nif (process.env.NODE_ENV === 'development') {\n  hbsRegisterPartials = hbsUtils.registerWatchedPartials.bind(hbsUtils);\n  hbsRegisterPartialsOpt = {\n    onchange(template) { console.log(`hbs partial [${template}] added/changed`); },\n  };\n}\nhbsRegisterPartials(path.join(__dirname, '../views/partials'), hbsRegisterPartialsOpt);\napp.set('view engine', 'hbs');\n\n/* without this, express incorrectly gets wrong header info because it thinks requests are coming\n   from nginx so for eg. req.protocol would be 'http' when it should be 'https' */\napp.set('trust proxy', true);\n\napp.use(globalMiddleware);\n\nio.on('connection', (socket) => {\n  console.log('New user connected');\n  genSocketEvents(socket, io);\n});\n\n// convert callback based methods to use promises\napp.use((req, res, next) => {\n  req.login = promisify(req.login.bind(req));\n  next();\n});\n\n// pass variables to all templates\napp.use((req, res, next) => {\n  const flashes = req.flash();\n  res.locals.user = req.user;\n  res.locals.flashes = Object.keys(flashes).length > 0 ? flashes : undefined;\n  next();\n});\napp.use('/', routes);\n\nexport { server as default, io };\n","import nodemailer from 'nodemailer';\n\nconst options = {\n  port: process.env.MAILER_PORT,\n  host: process.env.MAILER_HOST,\n  auth: {\n    user: process.env.MAILER_USERNAME,\n    pass: process.env.MAILER_PASSWORD,\n  },\n};\n\nconst transporter = nodemailer.createTransport(options);\n\ntransporter.verify((err) => {\n  if (err) {\n    console.log('mailer error:', err);\n  } else {\n    console.log('Mailer connected and authed');\n  }\n});\n\nconst sendMail = (to, subject, text, html) => transporter.sendMail({\n  to,\n  from: 'noreply@timiscoding.com',\n  subject,\n  text,\n  html,\n});\n\nexport { sendMail };\n","module.exports = require(\"body-parser\");","module.exports = require(\"moment\");","module.exports = require(\"bcrypt\");","module.exports = require(\"handlebars\");","import mongoose from 'mongoose';\nimport bcrypt from 'bcrypt';\nimport isEmail from 'validator/lib/isEmail';\nimport beautifyUnique from 'mongoose-beautiful-unique-validation';\nimport _ from 'lodash';\n\nconst userSchema = new mongoose.Schema({\n  username: {\n    type: String,\n    required: 'Username is required',\n    unique: 'Username already taken',\n    sparse: true,\n    lowercase: true,\n    trim: true,\n    match: [/^[\\w-]+$/, \"Username must contain alphanumeric, '-', '_' characters only\"],\n  },\n  local: {\n    email: {\n      type: String,\n      unique: 'An account with email {VALUE} already exists',\n      sparse: true, // allows us to add documents without unique fields\n      trim: true,\n      lowercase: true,\n      validate: [isEmail, 'Email is not valid'],\n    },\n    password: {\n      type: String,\n      trim: true,\n      minlength: 5,\n    },\n    isVerified: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  facebook: {\n    id: String,\n    token: String,\n    displayName: String,\n    email: String,\n  },\n  twitter: {\n    id: String,\n    token: String,\n    displayName: String,\n    username: String,\n  },\n  google: {\n    id: String,\n    token: String,\n    displayName: String,\n    email: String,\n  },\n});\n\nuserSchema.methods.isValidPassword = function isValidPassword(password) {\n  return bcrypt.compare(password, this.local.password);\n};\n\nconst types = ['twitter', 'google', 'facebook', 'local'];\nuserSchema.methods.accountsTotal = function accountsTotal() {\n  return Object.keys(this.toObject()).reduce((total, f) => {\n    if (types.includes(f)) {\n      if (f === 'local' || (f !== 'local' && this[f].token)) {\n        return total + 1;\n      }\n    }\n    return total;\n  }, 0);\n};\n\nuserSchema.statics.hashPassword = function hashPassword(plaintextPassword) {\n  if (!plaintextPassword) {\n    throw new Error('Password cannot be blank');\n  }\n  return bcrypt.hash(plaintextPassword, 12);\n};\n\nuserSchema.statics.genUniqueUsername = async function genUniqueUsername(name = 'anon') {\n  const snakeCase = name.toLowerCase().replace(/ /g, '_');\n  const usernameRegex = new RegExp(`^${snakeCase}\\d*$`);\n  const usernames = await this.find({ username: usernameRegex }, 'username');\n  let newUsername = snakeCase;\n  // find the first unique username with format username<incrementing number>\n  for (let i = 0; _.find(usernames, { username: newUsername }); i += 1) {\n    newUsername = snakeCase + (usernames.length + i);\n  }\n  return newUsername;\n};\n\n// if client tries creating a duplicate on a unique field, it will produce a low level\n// mongo db error. This plugin transforms that error into a mongoose validation error\n// that exists in an 'errors' object\nuserSchema.plugin(beautifyUnique);\n\nexport default mongoose.model('User', userSchema);\n","import mongoose from 'mongoose';\n\nconst emailVerifyTokenSchema = new mongoose.Schema({\n  user: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true,\n  },\n  createdAt: {\n    type: Date,\n    expires: '5 min',\n    default: Date.now,\n  },\n  token: {\n    type: String,\n    required: true,\n  },\n});\n\nexport default mongoose.model('EmailVerifyToken', emailVerifyTokenSchema);\n","import mongoose from 'mongoose';\nimport './models';\n\nconst connect = async () => mongoose.connect(process.env.DB_URL);\n\nexport default connect;\n\n","const isRealString = string => typeof string === 'string' && string.trim().length > 0;\n\nexport default isRealString;\n","import moment from 'moment';\n\nexport const generateMessage = (from, text) => ({\n  from,\n  text,\n  createdAt: moment().valueOf(),\n});\n\nexport const generateLocationMessage = (from, latitude, longitude) => ({\n  from,\n  url: `https://www.google.com/maps?q=${latitude},${longitude}`,\n  createdAt: moment().valueOf(),\n});\n","import isRealString from './utils/validation';\nimport { generateMessage, generateLocationMessage } from './utils/message';\nimport Users from './utils/users';\n\nconst users = Users.getInstance();\n\n// update room list for people joining a room\nconst updateUserJoining = (io) => {\n  io.emit('updateRoomList', { rooms: users.getRoomList() });\n};\n\nconst joinRoom = (socket, io) => socket.on('join', (params, callback) => {\n  if (!isRealString(params.name) || !isRealString(params.room)) {\n    return callback('Name and Room name are required!');\n  }\n\n  const name = params.name.trim();\n  const room = params.room.trim().toLowerCase();\n  const user = users.getUser({ name });\n\n  if (user && user.room === room) {\n    return callback('Username taken!');\n  }\n\n  socket.join(room);\n  users.removeUser(socket.id);\n  users.addUser(socket.id, name, room);\n  io.to(room).emit('updateUserList', users.getUserList(room));\n  socket.emit('newMessage', generateMessage('Admin', `Welcome to the room ${room}!`));\n  socket.broadcast.to(room).emit('newMessage', generateMessage('Admin', `${name} joined the chat`));\n\n  updateUserJoining(io);\n  return callback();\n});\n\nconst createMessage = (socket, io) => socket.on('createMessage', (message, callback) => {\n  const user = users.getUser({ id: socket.id });\n\n  if (user && isRealString(message.text)) {\n    io.to(user.room).emit('newMessage', generateMessage(user.name, message.text));\n  }\n  callback();\n});\n\nconst createLocationMessage = (socket, io) => socket.on('createLocationMessage', (coords) => {\n  const user = users.getUser({ id: socket.id });\n\n  if (user) {\n    io.to(user.room).emit('newLocationMessage', generateLocationMessage(user.name, coords.latitude, coords.longitude));\n  }\n});\n\nconst disconnect = (socket, io) => socket.on('disconnect', () => {\n  const user = users.removeUser(socket.id);\n\n  io.to(user.room).emit('updateUserList', users.getUserList(user.room));\n  io.to(user.room).emit('newMessage', generateMessage('Admin', `${user.name} has left`));\n  updateUserJoining(io);\n});\n\nconst getRoomList = socket => socket.on('getRoomList', (_, callback) => {\n  callback({ rooms: users.getRoomList() });\n});\n\nexport default (socket, io) => ({\n  joinRoom: joinRoom(socket, io),\n  createMessage: createMessage(socket, io),\n  createLocationMessage: createLocationMessage(socket, io),\n  disconnect: disconnect(socket, io),\n  getRoomList: getRoomList(socket, io),\n});\n","class UsersClass {\n  constructor() {\n    this.users = [];\n  }\n\n  addUser(id, name, room) {\n    const user = { id, name, room };\n    this.users.push(user);\n    return user;\n  }\n\n  removeUser(id) {\n    const userToRemove = Object.assign({}, this.getUser({ id }));\n\n    if (userToRemove) {\n      this.users = this.users.filter(user => user.id !== userToRemove.id);\n    }\n\n    return userToRemove;\n  }\n\n  getUser({ id, name }) {\n    return this.users.find(user => user.id === id || user.name === name);\n  }\n\n  getUserList(room) {\n    const users = this.users.filter(user => user.room === room);\n    const namesArray = users.map(user => user.name);\n\n    return namesArray;\n  }\n\n  getRoomList() {\n    const rooms = new Set(this.users.map(user => user.room));\n    return [...rooms];\n  }\n}\n\nconst Users = (() => {\n  let instance;\n\n  const createInstance = () => new UsersClass();\n\n  return {\n    getInstance() {\n      if (!instance) {\n        instance = createInstance();\n      }\n      return instance;\n    },\n  };\n})();\n\nexport default Users;\nexport { UsersClass };\n","import _ from 'lodash';\n\nconst userValidatorSchema = (...fields) => {\n  const schema = {\n    username: {\n      in: 'body',\n      isLength: {\n        errorMessage: 'Username must not be empty',\n        options: { min: 1 },\n      },\n      matches: {\n        errorMessage: \"Username must be letters, numbers, '_', '-' only\",\n        options: /^[\\w-]+$/,\n      },\n      trim: true,\n    },\n    email: {\n      in: 'body',\n      isEmail: {\n        errorMessage: 'Email address is not valid',\n      },\n      trim: true,\n      normalizeEmail: {\n        options: {\n          all_lowercase: true,\n          gmail_convert_googlemaildotcom: true,\n          gmail_remove_dots: true,\n          gmail_remove_subaddress: true,\n        },\n      },\n    },\n    password: {\n      in: 'body',\n      isLength: {\n        errorMessage: 'Password must be at least 5 characters long',\n        options: { min: 5 },\n      },\n      trim: true,\n    },\n    'password-confirm': {\n      in: 'body',\n      custom: {\n        options: (value, { req }) => {\n          if (req.body.password !== value) {\n            throw new Error('Password confirmation does not match password field');\n          }\n          return true;\n        },\n      },\n    },\n  };\n\n  return fields ? _.pick(schema, fields) : schema;\n};\n\nexport default userValidatorSchema;\n","export const catchAsyncError = fn => (req, res, next) => fn(req, res, next).catch(next);\n","import mongoose from 'mongoose';\nimport { checkSchema, validationResult } from 'express-validator/check';\nimport crypto from 'crypto';\n\nimport userValidatorSchema from './userValidatorSchema';\nimport { catchAsyncError } from '../utils/helpers';\nimport { sendMail } from '../mailer';\n\nconst User = mongoose.model('User');\nconst EmailVerifyToken = mongoose.model('EmailVerifyToken');\n\nconst signupForm = (req, res) => {\n  res.render('signup');\n};\n\nconst validateNewUser = [\n  checkSchema(userValidatorSchema()),\n  (req, res, next) => {\n    const errors = validationResult(req).formatWith(({ msg }) => msg);\n    if (errors.isEmpty()) {\n      next();\n    } else {\n      req.flash('error', errors.array({ onlyFirstError: true }));\n      res.render('signup', { body: req.body, flashes: req.flash() });\n    }\n  }];\n\nconst createOne = async (req, res, next) => {\n  const { email, password, username } = req.body;\n  try {\n    const user = await User.create({\n      local: { email, password: await User.hashPassword(password) },\n      username,\n    });\n\n    const emailToken = await EmailVerifyToken.create({\n      user: user.id,\n      token: crypto.randomBytes(20).toString('hex'),\n    });\n\n    const verifyURL = `${req.protocol}://${req.hostname}/confirm/${emailToken.token}`;\n    sendMail(email, 'Welcome to node-chat-app. Confirm your email', `By clicking the link, you are confirming your email address. ${verifyURL}`);\n\n    req.flash('info', `An email has been sent to ${email}. Please confirm your email to complete sign up.`);\n    res.redirect('/');\n  } catch (err) {\n    if (err.errors) {\n      const keys = Object.keys(err.errors);\n      const flashes = keys.map(key => err.errors[key].message);\n      req.flash('error', flashes);\n      res.render('signup', { body: { username, email }, flashes: req.flash() });\n    } else {\n      next(err);\n    }\n  }\n};\n\nconst confirmEmail = async (req, res) => {\n  const token = await EmailVerifyToken.findOneAndRemove({ token: req.params.token }).populate('user');\n  if (!token) {\n    req.flash('error', 'Email verification invalid. Please check the link.');\n    return res.redirect('/');\n  }\n\n  const { user } = token;\n  user.local.isVerified = true;\n  await user.save();\n  await req.login(user);\n  req.flash('success', 'Your email has been confirmed. You are now logged in');\n  return res.redirect('/');\n};\n\nconst getOne = async (req, res) => {\n  const user = await User.findById(req.user.id);\n  res.send(`get user\\n ${user}`);\n};\n\nconst updateOne = (req, res) => {\n  res.send(`update user\\n ${req.docFromId}`);\n};\n\nconst deleteOne = (req, res) => {\n  res.send(`delete user\\n ${req.docFromId}`);\n};\n\nexport default {\n  createOne: catchAsyncError(createOne),\n  getOne: catchAsyncError(getOne),\n  updateOne: catchAsyncError(updateOne),\n  deleteOne: catchAsyncError(deleteOne),\n  signupForm,\n  validateNewUser,\n  confirmEmail: catchAsyncError(confirmEmail),\n};\n","import express from 'express';\nimport { ensureLoggedIn } from 'connect-ensure-login';\nimport mongoose from 'mongoose';\nimport userController from '../controllers/user.controller';\n\nexport const userRouter = express.Router();\nconst User = mongoose.model('User');\n\nuserRouter.param('id', async (req, res, next, id) => {\n  try {\n    if (!mongoose.Types.ObjectId.isValid(id)) {\n      throw new Error('Invalid user id');\n    }\n    const user = await User.findById(id);\n    if (!user) {\n      throw new Error('No user found');\n    } else {\n      req.docFromId = user;\n      next();\n    }\n  } catch (err) {\n    next(err.message);\n  }\n});\n\nuserRouter.route('/signup')\n  .get(userController.signupForm)\n  .post(userController.validateNewUser, userController.createOne);\n\nuserRouter.route('/user/:id')\n  .get(ensureLoggedIn(), userController.getOne)\n  .put(userController.updateOne)\n  .delete(userController.deleteOne);\n\nuserRouter.get('/confirm/:token', userController.confirmEmail);\n","import passport from 'passport';\nimport mongoose from 'mongoose';\nimport { checkSchema, validationResult } from 'express-validator/check';\n\nimport userValidatorSchema from './userValidatorSchema';\n\nconst User = mongoose.model('User');\n\nconst loginForm = (req, res) => res.render('login');\n\n// logs in a user\nconst loginUser = passport.authenticate('local', {\n  successReturnToOrRedirect: '/',\n  failureRedirect: '/login',\n  failureFlash: true,\n  successFlash: 'You have logged in',\n});\n\nconst logoutUser = (req, res) => {\n  req.logout();\n  req.flash('info', 'You have logged out');\n  res.redirect('/');\n};\n\n// checks credentials but does not log them in\nconst authLocal = passport.authorize('local', {\n  failureRedirect: '/link/local',\n  failureFlash: 'Email or password is invalid',\n});\n\nconst linkLocalForm = (req, res) => res.render('link_local');\n\nconst genOauthLogin = (provider, config = {}) => ({\n  auth(req, res, next) {\n    const fn = req.user ? passport.authorize : passport.authenticate;\n    return fn.call(passport, provider, config.scope && { scope: config.scope })(req, res, next);\n  },\n  authCb(req, res, next) {\n    const fn = req.user ? passport.authorize : passport.authenticate;\n    const routes = req.user ?\n      {\n        failureRedirect: '/profile',\n        failureFlash: `${provider} account was not linked`,\n      } :\n      (err, user, info) => {\n        if (err) { return next(err); }\n        if (!user) {\n          req.flash('error', `Permission to login via ${provider} was denied`);\n          return res.redirect('/login');\n        }\n\n        return req.login(user, (error) => {\n          if (error) { return next(error); }\n          req.flash('success', `You have logged in, ${user[provider].displayName || user[provider].username}`);\n          if (info.firstLogin) { return res.redirect('/profile'); }\n          return res.redirect('/');\n        });\n      };\n    return fn.call(passport, provider, routes)(req, res, next);\n  },\n});\n\nconst linkAccount = async (req, res, next) => {\n  const { user, account } = req;\n\n  // user who has already logged in has authorised another account so we need to link them\n  if (user && account) {\n    const accountObj = account.toObject({\n      transform(doc, ret) {\n        const newRet = Object.assign({}, ret);\n        delete newRet.__v;\n        delete newRet._id;\n        return newRet;\n      },\n    });\n    if (accountObj.local) {\n      /* if req.user is a social account and they try to link to local, then we must delete the\n          local account otherwise there will be a duplicate in the db when we try to add the local\n          info to the social account. Since the user model doesn't allow duplicate emails, it will\n          throw an error if we didn't do this */\n      await User.deleteOne({ 'local.email': accountObj.local.email });\n    }\n    // merge accounts but preserve original username\n    Object.assign(user, accountObj, { username: user.username });\n    await user.save();\n    await account.remove();\n    req.flash('success', 'Accounts have been linked');\n    return res.redirect('/profile');\n  }\n  return next();\n};\n\nconst unlinkAccount = async (req, res, next) => {\n  const type = req.params.account;\n  const types = ['twitter', 'google', 'facebook', 'local'];\n  const { user } = req;\n  if (!types.includes(type)) {\n    const err = new Error('Unknown account type');\n    err.status = 400;\n    return next(err);\n  }\n\n  if (user.accountsTotal === 1) {\n    req.flash('error', 'Unable to unlink solo account');\n    return res.redirect('/profile');\n  }\n\n  if (type === 'local') {\n    const local = Object.assign({}, user.local);\n    user.local = undefined;\n    await user.save();\n    await User.create({ local, username: await User.genUniqueUsername() });\n  } else {\n    user[type].token = undefined;\n    await user.save();\n  }\n  req.flash('success', 'Account has been unlinked');\n  res.redirect('/profile');\n};\n\nconst profile = async (req, res) => {\n  res.render('profile', { body: { username: req.user.username } });\n};\n\nconst validateProfile = [\n  checkSchema(userValidatorSchema('username')),\n  (req, res, next) => {\n    const errors = validationResult(req).formatWith(({ msg }) => msg);\n    if (errors.isEmpty()) {\n      next();\n    } else {\n      req.flash('error', errors.array({ onlyFirstError: true }));\n      res.render('profile', { body: req.body, flashes: req.flash() });\n    }\n  },\n];\n\nconst updateProfile = async (req, res) => {\n  req.user.username = req.body.username;\n  await req.user.save();\n  req.flash('success', 'Username updated');\n  res.redirect('/profile');\n};\n\nexport default {\n  loginForm,\n  loginUser,\n  logoutUser,\n  genOauthLogin,\n  profile,\n  authLocal,\n  linkAccount,\n  unlinkAccount,\n  linkLocalForm,\n  validateProfile,\n  updateProfile,\n};\n","import express from 'express';\n\nimport authController from '../controllers/auth.controller';\nimport { catchAsyncError } from '../utils/helpers';\n\nconst isLoggedIn = (req, res, next) => {\n  if (req.isAuthenticated()) {\n    next();\n  } else {\n    res.redirect('/');\n  }\n};\n\nexport const authRouter = express.Router();\n\nauthRouter.get('/login', authController.loginForm);\nauthRouter.post('/login', authController.loginUser);\nauthRouter.get('/logout', isLoggedIn, authController.logoutUser);\nauthRouter.get('/profile', isLoggedIn, catchAsyncError(authController.profile));\nauthRouter.post('/profile', isLoggedIn, authController.validateProfile, catchAsyncError(authController.updateProfile));\nauthRouter.get('/link/local', isLoggedIn, authController.linkLocalForm);\nauthRouter.post('/link/local', isLoggedIn, authController.authLocal, catchAsyncError(authController.linkAccount));\nauthRouter.post('/unlink/:account', isLoggedIn, catchAsyncError(authController.unlinkAccount));\n\n[\n  {\n    provider: 'facebook',\n    config: {\n      scope: 'email',\n    },\n  },\n  { provider: 'twitter' },\n  {\n    provider: 'google',\n    config: {\n      scope: 'https://www.googleapis.com/auth/userinfo.profile',\n    },\n  },\n].forEach(({ provider, config }) => {\n  const { auth, authCb } = authController.genOauthLogin(provider, config);\n  authRouter.get(`/auth/${provider}`, auth);\n  authRouter.get(`/auth/${provider}/callback`, authCb, catchAsyncError(authController.linkAccount));\n  authRouter.get(`/link/${provider}`, isLoggedIn, auth);\n});\n","import express from 'express';\nimport { userRouter } from './user.router';\nimport { authRouter } from './auth.router';\n\nconst routes = express.Router();\n\nroutes.use('/', authRouter);\nroutes.use('/', userRouter);\n\nroutes.get('/', (req, res) => {\n  res.render('index', { title: 'Join' });\n});\n\nroutes.post('/chat', (req, res) => {\n  res.render('chat', { title: 'Chat' });\n});\n\n// handle mongoose validation errors\nroutes.use((err, req, res, next) => {\n  if (!err.errors) {\n    return next(err);\n  }\n\n  const validationErrors = Object.keys(err.errors);\n\n  if (validationErrors.length > 0) {\n    validationErrors.forEach(e => req.flash('error', err.errors[e].message));\n  }\n  return res.redirect('back');\n});\n\nif (process.env.NODE_ENV === 'development') {\n  routes.use((err, req, res, next) => { // eslint-disable-line no-unused-vars\n    res.status(err.status || 500).send(`something messed up: ${err.message}`);\n  });\n}\n\nroutes.use((err, req, res, next) => { // eslint-disable-line no-unused-vars\n  const status = err.status || 500;\n  res.status(status).render('error', { status, message: err.message });\n});\n\nexport default routes;\n","module.exports = require(\"crypto\");","module.exports = require(\"connect-ensure-login\");","module.exports = require(\"connect-flash\");","module.exports = require(\"express-session\");","import express from 'express';\nimport path from 'path';\nimport bodyParser from 'body-parser';\nimport passport from 'passport';\nimport session from 'express-session';\nimport flash from 'connect-flash';\n\nexport default [\n  express.static(path.join(__dirname, '../public')),\n  bodyParser.json(),\n  bodyParser.urlencoded({ extended: true }),\n  session({ secret: process.env.SESSION_SECRET, resave: false, saveUninitialized: false }),\n  passport.initialize(),\n  passport.session(),\n  flash(),\n];\n","module.exports = require(\"nodemailer\");","module.exports = require(\"passport-google-oauth\");","module.exports = require(\"passport-twitter\");","module.exports = require(\"passport-facebook\");","module.exports = require(\"passport-local\");","module.exports = require(\"mongoose-beautiful-unique-validation\");","module.exports = require(\"validator/lib/isEmail\");","module.exports = require(\"es6-promisify\");","module.exports = require(\"hbs-utils\");","module.exports = require(\"socket.io\");","module.exports = require(\"http\");","import passport from 'passport';\nimport LocalStrategy from 'passport-local';\nimport FacebookStrategy from 'passport-facebook';\nimport TwitterStrategy from 'passport-twitter';\nimport { OAuth2Strategy as GoogleStrategy } from 'passport-google-oauth';\nimport mongoose from 'mongoose';\nimport _ from 'lodash';\n\nconst User = mongoose.model('User');\n\npassport.use(new LocalStrategy(\n  { usernameField: 'email', passReqToCallback: true },\n  async (req, email, password, done) => {\n    try {\n      const user = await User.findOne({ 'local.email': email });\n      if (!user) {\n        return done(null, false, { message: 'Email or password is invalid' });\n      }\n\n      const isValidPassword = await user.isValidPassword(password);\n      if (!isValidPassword) {\n        return done(null, false, { message: 'Email or password is invalid' });\n      }\n\n      if (!user.local.isVerified) {\n        return done(null, false, { message: 'Your account needs to be verified via email before you can log in' });\n      }\n\n      /* user is either\n         a) already logged in via oauth and trying to link this local account so the user will be\n         injected into req.account\n         b) logging into their local account so the user will be injected into req.user */\n      return done(null, user);\n    } catch (err) {\n      return done(err, null, { message: 'Could not authenticate. Please try again' });\n    }\n  },\n));\n\nconst getEmail = profile => profile.emails && profile.emails.length && profile.emails[0].value;\nconst createAccount = async (provider, token, profile) => User.create({\n  [provider]: {\n    id: profile.id,\n    displayName: profile.displayName,\n    token,\n    email: getEmail(profile),\n  },\n  username: await User.genUniqueUsername(profile.username || profile.displayName),\n});\n\nconst genOauthCb = provider => async (req, accessToken, refreshTokenOrSecret, profile, done) => {\n  try {\n    let user = await User.findOne({ [`${provider}.id`]: profile.id });\n    if (!req.user) { // not already logged in\n      if (user) {\n        if (!user[provider].token) { // user unlinked this account but has logged in later\n          user[provider] = {\n            id: profile.id,\n            displayName: profile.displayName,\n            token: accessToken,\n            email: getEmail(profile),\n          };\n          user = await user.save();\n        }\n        return done(null, user);\n      }\n\n      user = await createAccount(provider, accessToken, profile);\n\n      /* when a user logs in for the first time, we need a way to inform the authController so that\n         they can send them to a profile page to let them change their username if they want.\n         firstLogin is my own custom prop that will be sent to the custom callback whenever\n         passport.auth(enticate|orize)() is called\n         */\n      return done(null, user, { firstLogin: true });\n    }\n    /* user already logged in and trying to link another account  */\n\n    /* if user tries to link an already linked account, just return the original user */\n    if (user) {\n      /* user previously unlinked account and now wants to relink it.\n        we must update the token and other profile info */\n      if (!user[provider].token) {\n        user = await createAccount(provider, accessToken, profile);\n      }\n      return done(null, user);\n    }\n\n    /* user linking an account they have never authorised before so lets create it first */\n    user = await createAccount(provider, accessToken, profile);\n\n    return done(null, user);\n  } catch (err) {\n    return done(err, false, { message: 'Could not authenticate. Please try again' });\n  }\n};\n\npassport.use(new FacebookStrategy(\n  {\n    clientID: process.env.FACEBOOK_APP_ID,\n    clientSecret: process.env.FACEBOOK_APP_SECRET,\n    callbackURL: `${process.env.DOMAIN}/auth/facebook/callback`,\n    profileFields: ['email', 'displayName'],\n    passReqToCallback: true,\n  },\n  genOauthCb('facebook'),\n));\n\npassport.use(new TwitterStrategy(\n  {\n    consumerKey: process.env.TWITTER_CONSUMER_KEY,\n    consumerSecret: process.env.TWITTER_CONSUMER_SECRET,\n    callbackURL: `${process.env.DOMAIN}/auth/twitter/callback`,\n    passReqToCallback: true,\n  },\n  genOauthCb('twitter'),\n));\n\npassport.use(new GoogleStrategy(\n  {\n    clientID: process.env.GOOGLE_APP_ID,\n    clientSecret: process.env.GOOGLE_APP_SECRET,\n    callbackURL: `${process.env.DOMAIN}/auth/google/callback`,\n    passReqToCallback: true,\n  },\n  genOauthCb('google'),\n));\n\npassport.serializeUser((user, done) => done(null, user.id));\npassport.deserializeUser(async (id, done) => {\n  try {\n    const user = await User.findById(id);\n    return done(null, user);\n  } catch (err) {\n    return done(err);\n  }\n});\n","/* eslint-disable no-console */\n\nimport server, { io } from './server';\n\nconst port = process.env.PORT || 4000;\nlet cServer = server;\nlet cIo = io;\n\nif (module.hot) {\n  module.hot.accept('./server', () => {\n    console.log('Re-attaching event listeners to updated server module');\n    cServer.close();\n    server.listen(port);\n    cServer = server;\n\n    cIo.close();\n    io.attach(cServer);\n    cIo = io;\n  });\n}\n\nserver.listen(port, () => {\n  console.log(`Server started on port ${port}`);\n});\n"],"sourceRoot":""}